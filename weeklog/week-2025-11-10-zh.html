<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StepLog | Weekly Template (ä¸­æ–‡)</title>
  <!-- æ³¨æ„ï¼šæ¨¡æ¿åœ¨ weeklog/ ç›®å½•é‡Œï¼Œæ‰€ä»¥è¦ç”¨ ../style.css -->
  <link rel="stylesheet" href="../style.css" />
</head>
<body>
  <!-- é¡¶éƒ¨è„šæœ¬ï¼šç»Ÿä¸€æ§åˆ¶è¿™ä¸€å‘¨çš„èµ·å§‹æ—¥æœŸ & æ ‡é¢˜ & æ—¥æœŸèŒƒå›´ & æ¯æ—¥æ—¥æœŸ -->
  <script>
    // âœ… æ¯å‘¨é¡µé¢å¤åˆ¶è¿™ä¸ªæ¨¡æ¿åï¼Œåªéœ€è¦æ”¹è¿™ä¸€è¡Œï¼š
    // è¿™ä¸€å‘¨çš„ã€Œå‘¨ä¸€ã€æ—¥æœŸï¼Œæ ¼å¼ YYYY-MM-DD
    const WEEK_START = "2025-11-10";
    // æ¨¡ç‰ˆç‰ˆæœ¬å·ï¼šæ‰‹åŠ¨æ›´æ–°ä¸ºæœ¬æ–‡ä»¶æœ€åä¸€æ¬¡ä¿®æ”¹æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰
    const TEMPLATE_VERSION = "2025-11-23";

    // --- æ—¥æœŸå·¥å…·ï¼šä¸å—æµè§ˆå™¨æœ¬åœ°æ—¶åŒºå½±å“ï¼Œå…¨éƒ¨æŒ‰â€œUTC æ—¥å†æ—¥â€è®¡ç®— ---

    // æŠŠ "YYYY-MM-DD" è§£ææˆä¸€ä¸ªâ€œUTC æ—¥æœŸå¯¹è±¡â€
    function makeUTCDate(ymdStr) {
      const [y, m, d] = ymdStr.split("-").map(Number);
      return new Date(Date.UTC(y, m - 1, d));
    }

    // ä»¥â€œUTC æ—¥å†â€è¾“å‡º YYYY-MM-DD
    function formatUTCDate(date) {
      const y = date.getUTCFullYear();
      const m = String(date.getUTCMonth() + 1).padStart(2, "0");
      const d = String(date.getUTCDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function computeWeekDates(startStr) {
      const start = makeUTCDate(startStr);
      const end = new Date(start.getTime() + 6 * 24 * 60 * 60 * 1000); // +6 days

      return {
        startStr: formatUTCDate(start),
        endStr: formatUTCDate(end),
        label: `Week ${formatUTCDate(start)}`,
        dateRange: `${formatUTCDate(start)} â†’ ${formatUTCDate(end)}`,
      };
    }

    // ---- Training cycle data for Berlin 2026 project ----
    // ä½¿ç”¨ã€Œå‘¨æœŸèµ·å§‹/ç»“æŸæ—¥æœŸã€è‡ªåŠ¨ç”Ÿæˆæ¯å‘¨çš„ startDateï¼Œé¿å…æ‰‹åŠ¨æšä¸¾æ‰€æœ‰å‘¨
    const CYCLES_CONFIG = [
      {
        id: 1,
        name: "è®­ç»ƒå‘¨æœŸ1 Â· é˜¿è±æ–¯10å…¬é‡Œèµ›",
        startDate: "2025-09-29", // å‘¨ä¸€
        endDate: "2025-11-09",   // æ¯”èµ›å‘¨çš„å‘¨æ—¥ï¼ˆAlÃ¨s 10Kï¼‰
      },
      {
        id: 2,
        name: "è®­ç»ƒå‘¨æœŸ2 Â· å·´å¡ç½—é‚£åŠç¨‹é©¬æ‹‰æ¾",
        startDate: "2025-11-10", // å‘¨ä¸€
        endDate: "2026-02-15",   // æ¯”èµ›æ—¥ï¼ˆBarcelona Half Marathonï¼‰
      },
      {
        id: 3,
        name: "è®­ç»ƒå‘¨æœŸ3 Â· è’™æ‰˜é‚¦é©¬æ‹‰æ¾",
        startDate: "2026-02-23",
        endDate: "2026-03-29",
      },
      {
        id: 4,
        name: "è®­ç»ƒå‘¨æœŸ4 Â· æ³•å›½é©¬æ‹‰æ¾é”¦æ ‡èµ›",
        startDate: "2026-04-06",
        endDate: "2026-05-03",
      },
      {
        id: 5,
        name: "è®­ç»ƒå‘¨æœŸ5 Â· å¤è®­å‘¨æœŸ",
        startDate: "2026-05-04",
        endDate: "2026-08-30",
      },
      {
        id: 6,
        name: "æœ€åå‡†å¤‡Â· 2026æŸæ—é©¬æ‹‰æ¾",
        startDate: "2026-08-31",
        endDate: "2026-09-27",
      },
    ];

    function generateCyclesData(configs) {
      const result = [];
      const ONE_DAY_MS = 24 * 60 * 60 * 1000;
      configs.forEach((cfg) => {
        const start = makeUTCDate(cfg.startDate);
        const end = makeUTCDate(cfg.endDate);
        const weeks = [];

        let wStart = new Date(start.getTime());
        let order = 1;
        while (wStart <= end) {
          weeks.push({
            order,
            startDate: formatUTCDate(wStart),
          });
          wStart = new Date(wStart.getTime() + 7 * ONE_DAY_MS);
          order += 1;
        }

        result.push({
          id: cfg.id,
          name: cfg.name,
          weeks,
        });
      });
      return result;
    }

    const CYCLES_DATA = generateCyclesData(CYCLES_CONFIG);

    function findCycleInfoForWeek(weekStartStr) {
      for (const cycle of CYCLES_DATA) {
        if (!cycle.weeks) continue;
        const match = cycle.weeks.find((w) => w.startDate === weekStartStr);
        if (match) {
          return {
            cycleName: cycle.name,
            weekOrder: match.order,
          };
        }
      }
      return null;
    }

    document.addEventListener("DOMContentLoaded", () => {
      const info = computeWeekDates(WEEK_START);

      // è®¾ç½®é¡µé¢æ ‡é¢˜
      document.title = `StepLog | ${info.label}`;

      // å¡«å……é¡¶éƒ¨æ ‡é¢˜ & å‘¨æ—¥æœŸ
      document.querySelectorAll("[data-week-label]").forEach((el) => {
        el.textContent = `${info.label}å½“å‘¨`;
      });
      document.querySelectorAll("[data-week-dates]").forEach((el) => {
        el.textContent = info.dateRange;
      });

      // å¡«å…… Training cycleï¼šæ ¹æ® WEEK_START æ˜ å°„åˆ° "Cycle X Â· Week Y"
      const cycleLabelEl = document.getElementById("week-cycle-label");
      if (cycleLabelEl) {
        const cycleInfo = findCycleInfoForWeek(WEEK_START);
        if (cycleInfo) {
          cycleLabelEl.textContent = `${cycleInfo.cycleName} Â· ç¬¬${cycleInfo.weekOrder}å‘¨`;
        } else {
          // å¦‚æœæœªæ‰¾åˆ°åŒ¹é…ï¼Œå¯ä»¥ä¿ç•™å ä½æˆ–æ¸…ç©º
          cycleLabelEl.textContent = "â€“";
        }
      }

      // å¡«å…… footer ä¸­çš„æ¨¡ç‰ˆç‰ˆæœ¬å·
      const versionEl = document.getElementById("template-version-label");
      if (versionEl && typeof TEMPLATE_VERSION === "string" && TEMPLATE_VERSION) {
        versionEl.textContent = `(ç‰ˆæœ¬ ${TEMPLATE_VERSION})`;
      }

      // ä¸ºã€Œæ¯æ—¥è®¡åˆ’è¡¨ã€è‡ªåŠ¨å¡«æ—¥æœŸï¼ˆMonâ€“Sunï¼‰
      const base = makeUTCDate(info.startStr);
      document.querySelectorAll("tr[data-day-offset]").forEach((row) => {
        const offset = Number(row.getAttribute("data-day-offset") || "0");
        const d = new Date(base.getTime() + offset * 24 * 60 * 60 * 1000);
        const dateStr = formatUTCDate(d);
        const cell = row.querySelector("[data-day-date]");
        if (cell) {
          cell.textContent = dateStr;
        }
      });
    });
  </script>

  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <header class="site-header">
    <div class="container header-inner">
      <div class="logo">StepLog</div>
      <nav class="nav">
        <a href="../index.html">å›ä¸»é¡µ</a>
        <a>å‘¨è§†å›¾</a>
      </nav>
    </div>
  </header>

  <!-- å½“å‰å‘¨æ¦‚è§ˆ -->
  <section class="section week-hero">
    <div class="container">
      <h1 data-week-label>å½“å‘¨</h1>
      <p class="section-subtitle">
        ä¸€ä¸ªä»¥2026å¹´æŸæ—é©¬æ‹‰æ¾ä¸ºç›®æ ‡çš„è®­ç»ƒå­£
      </p>

      <div class="week-meta-row">
        <div class="meta-pill">
          <span class="meta-label">æ—¥æœŸè·¨åº¦</span>
          <span class="meta-value" data-week-dates>YYYY-MM-DD â†’ YYYY-MM-DD</span>
        </div>
        <div class="meta-pill">
          <span class="meta-label">æ‰€å¤„è®­ç»ƒé˜¶æ®µ</span>
          <span class="meta-value" id="week-cycle-label">##Cycle X Â· Week Y##</span>
        </div>
        <div class="meta-pill">
          <span class="meta-label">ç›®æ ‡</span>
    <!-- ğŸŸ¢ğŸŸ¢To fillin focus of week!! ğŸ‘‡ğŸŸ¢ğŸŸ¢ -->
          <span class="meta-value">##æœ¬å‘¨ä¸»è¦ç›®æ ‡##</span>
        </div>
      </div>
    </div>
  </section>

  <!-- 1 Â· Weekly Planning -->
  <section class="section section-alt">
    <div class="container">
      <h2>1 Â· æœ¬å‘¨è®¡åˆ’</h2>
      <p class="section-subtitle">
        æˆ‘ç°åœ¨æ­£åœ¨éµå¾ª Pfizingerçš„æ¯å‘¨55-70è‹±é‡Œè®­ç»ƒè®¡åˆ’ï¼Œé…åˆä¿±ä¹éƒ¨è®­ç»ƒã€‚è¿™ä¸€éƒ¨åˆ†ä¼šä»¥æˆ‘çš„Garminè®­ç»ƒæ—¥å†åŒæ­¥ã€‚
      </p>      

      <!-- æ–°å¢ï¼šå‘¨æ—¥å†è§†å›¾ï¼ˆä» Outlook/ICS è½¬æ¥çš„ JSONï¼‰ -->
      <div class="week-calendar-block">
        <h3 class="week-subtitle">å‘¨æ—¥ç¨‹</h3>
        <div id="week-planning-calendar" class="week-cal-grid">
          <!-- JS ä¼šåœ¨è¿™é‡Œå¡«å…¥ä¸€æ•´å‘¨ Monâ€“Sun çš„å°æ ¼å­ -->
        </div>
      </div>

      <!-- ä¸‹åŠéƒ¨åˆ†ï¼šæ¯æ—¥è®¡åˆ’è¡¨ï¼ˆæ—¥æœŸè‡ªåŠ¨å¡«å……ï¼‰ -->
      <div class="week-table-block">
        <h3 class="week-subtitle">æ¯æ—¥è®¡åˆ’</h3>
        <table class="week-table">
          <thead>
            <tr>
              <th>æ˜ŸæœŸ</th>
              <th>æ—¥æœŸ</th>
              <th>è®¡åˆ’</th>
            </tr>
          </thead>
          <tbody id="planned-session-body">
            <tr>
              <td colspan="3">è®¡åˆ’ä¼šä»calendar-events.jsonè‡ªåŠ¨å¯¼å…¥â€¦</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- 2 Â· å‘¨è®¡åˆ’æ‰§è¡Œæ¦‚è¦ -->
  <section id="summary" class="section">
    <div class="container">
      <h2>2 Â· å‘¨è®¡åˆ’æ‰§è¡Œæ¦‚è¦</h2>
      <p class="section-subtitle">
        è¿™ä¸€éƒ¨åˆ†å°†ä»Stravaæ•°æ®å¯¼å…¥.
      </p>

      <!-- é¡¶éƒ¨ï¼šæŒ‡æ ‡ï¼ˆéƒ¨åˆ†è‡ªåŠ¨å¡«å……ï¼‰ -->

      <div class="week-summary-metrics">
        <div class="metric-card">
          <p class="metric-label">å®Œæˆè·ç¦»</p>
          <p class="metric-value"><span id="completed-distance">â€“</span></p>
        </div>
        <div class="metric-card">
          <p class="metric-label">è®­ç»ƒè¯¾ç¨‹æ•°é‡</p>
          <p class="metric-value"><span id="session-count">â€“</span></p>
        </div>
        <div class="metric-card">
          <p class="metric-label">å¹³å‡å¼ºåº¦</p>
          <p class="metric-value"><span id="general-feeling">â€“</span></p>
        </div>
      </div>

      <div class="week-execution-grid">
        <!-- å·¦ä¾§ï¼šå‘¨æ—¥å† + åˆ—è¡¨ï¼ˆæ¥è‡ª Stravaï¼‰ -->
        <div>
          <p></p>
          <h3 class="week-subtitle">æ‰§è¡Œæ—¥å†(æ•°æ®æ¥è‡ªStrava)</h3>
          <div id="week-exec-calendar" class="week-cal-grid">
            <!-- JS will populate this with Monâ€“Sun cells -->
          </div>

      <h4 class="week-subtitle week-subtitle-margin-small">
        æ¯æ—¥å®é™…è®­ç»ƒ
      </h4>
      <table class="week-table small">
        <thead>
          <tr>
            <th>æ˜ŸæœŸ</th>
            <th>æ—¥æœŸ</th>
            <th>é•¿åº¦</th>
            <th>å¹³å‡é…é€Ÿ</th>
            <th>å¹³å‡å¿ƒç‡</th>
            <th>è®­ç»ƒåç§°</th>
            <th>åœ°ç‚¹</th>
            <th>è¯„è®ºå’Œä½“ä¼š</th>
          </tr>
        </thead>
        <tbody id="exec-session-body">
          <tr>
            <td colspan="6">
              å·²æ‰§è¡Œçš„è®­ç»ƒæ•°æ®å°†ä» Strava å‘¨ JSON æ–‡ä»¶ä¸­åŠ è½½â€¦â€¦
            </td>
          </tr>
        </tbody>
      </table>


        </div>
      </div>

      <div class="week-final-note">
        <h3 class="week-subtitle">æ¯å‘¨è®°å½•</h3>
        <p>è¿™æ˜¯æˆ‘å‘¨æœ«çš„å®¶åº­ä½œä¸šï¼Œå‘¨æœ«è§ã€‚</p>
      </div>
    </div>
  </section>

  <footer class="site-footer">
    <div class="container footer-inner">
      <p>StepLog Â· å‘¨æŠ¥å‘Š <span id="template-version-label"></span></p>
      <p class="footer-sub"><b>è®¡åˆ’åœ¨å¿ƒï¼Œè„šè¸å®åœ°ã€‚</b><br>æƒ³äº†è§£æˆ‘æ˜¯è°ï¼Ÿçœ‹è¿™é‡Œ Â© <a href="https://github.com/BlanQwall/">BAI Qiang</a></p>
    </div>
  </footer>

  <!-- åº•éƒ¨è„šæœ¬ï¼šStrava å‘¨æ•°æ® + Garmin/Outlook å‘¨æ—¥å† -->

    <script>
      // Strava å‘¨æ•°æ® JSONï¼šç”± build_week.py ç”Ÿæˆï¼Œæ–‡ä»¶åçº¦å®šä¸º week-<WEEK_START>.json
      const WEEK_JSON = `../data/week-${WEEK_START}.zh.json`;

      // å·¥å…·ï¼šæŠŠ m/s è½¬æˆ "mm:ss /km"
      function formatPaceFromSpeed(speed) {
        if (typeof speed !== "number" || speed <= 0) return "â€“";
        const secPerKm = 1000 / speed; // seconds per km
        const totalSec = Math.round(secPerKm);
        const min = Math.floor(totalSec / 60);
        const sec = totalSec % 60;
        return `${min}:${String(sec).padStart(2, "0")} åˆ†/å…¬é‡Œ`;
      }

      function formatHr(hr) {
        if (typeof hr !== "number" || hr <= 0) return "â€“";
        return Math.round(hr) + " æ¬¡/åˆ†é’Ÿ";
      }

      async function loadWeekData() {
        try {
          const res = await fetch(WEEK_JSON);
          if (!res.ok) {
            console.error("Failed to load week JSON", res.status);
            return;
          }

          const data = await res.json();
          console.log("Week data loaded:", data);

          // 1) é¡¶éƒ¨æŒ‡æ ‡ï¼šCompleted distance & Sessions & General feeling
          const completedSpan = document.getElementById("completed-distance");
          const sessionsSpan = document.getElementById("session-count");
          const feelingSpan = document.getElementById("general-feeling");

          if (completedSpan && typeof data.total_distance_km === "number") {
            completedSpan.textContent = data.total_distance_km + " å…¬é‡Œ";
          }
          if (sessionsSpan && typeof data.activity_count === "number") {
            sessionsSpan.textContent = data.activity_count;
          }

          if (feelingSpan) {
            let score = data.avg_suffer_score;
            // å¦‚æœåç«¯æ²¡ç®—åˆ°ï¼Œå°±åœ¨å‰ç«¯ç”¨ activities ç®—ä¸€ä¸ª
            if (typeof score !== "number" && Array.isArray(data.activities)) {
              let sSum = 0;
              let sCount = 0;
              data.activities.forEach((act) => {
                if (typeof act.suffer_score === "number") {
                  sSum += act.suffer_score;
                  sCount += 1;
                }
              });
              if (sCount > 0) score = sSum / sCount;
            }
            if (typeof score === "number") {
              feelingSpan.textContent = (score).toFixed(1);
            }
          }

          // 2) èšåˆæˆ â€œæŒ‰å¤©â€ çš„æ•°æ®ï¼Œç”¨æ¥ç”»æ‰§è¡Œå‘¨æ—¥å† + è¡¨æ ¼
          const info = computeWeekDates(WEEK_START);
          const weekStart = makeUTCDate(info.startStr);
          const weekEnd = makeUTCDate(info.endStr);

          const byDate = {};   // { "YYYY-MM-DD": { totalKm, sessions: [{id, name, distance_km, speed, hr}] } }
          const flatList = []; // æ‰§è¡Œåˆ—è¡¨è¡¨æ ¼è¡Œ

          if (Array.isArray(data.activities)) {
            data.activities.forEach((act) => {
              if (!act.date) return;
              const dateStr = act.date; // "YYYY-MM-DD"
              const d = makeUTCDate(dateStr);

              if (d < weekStart || d > weekEnd) return; // åªä¿ç•™è¿™ä¸€å‘¨

              const dist = typeof act.distance_km === "number" ? act.distance_km : 0;
              const id = act.id;
              const name = act.name || "Session";
              const speed = typeof act.average_speed_m_s === "number" ? act.average_speed_m_s : null;
              const hr = typeof act.average_heartrate === "number" ? act.average_heartrate : null;
              const city = act.city || null;
              const country = act.country || null;
              const description = act.description || "";

              if (!byDate[dateStr]) {
                byDate[dateStr] = { totalKm: 0, sessions: [] };
              }
              byDate[dateStr].totalKm += dist;
              byDate[dateStr].sessions.push({
                id,
                name,
                distance_km: dist,
                speed,
                hr,
              });

              const dayLabel = weekdayShortUTC(d);
              flatList.push({
                day: dayLabel,
                date: dateStr,
                name,
                distance_km: dist,
                id,
                speed,
                hr,
                city,
                country,
                description,
              });
            });
          }

          // 3) æ¸²æŸ“æ‰§è¡Œå‘¨æ—¥å† + æ‰§è¡Œ sessions è¡¨æ ¼
          renderExecWeeklyCalendar(byDate, info);
          renderExecSessionsTable(flatList);
        } catch (err) {
          console.error("Error loading week data:", err);
        }
      }

      // æ‰§è¡Œå‘¨æ—¥å†ï¼ˆå·¦è¾¹é‚£ä¸€æ’æ ¼å­ï¼‰
      function renderExecWeeklyCalendar(byDate, info) {
        const container = document.getElementById("week-exec-calendar");
        if (!container) return;

        const base = makeUTCDate(info.startStr);
        const weekdays = ["å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­", "å‘¨æ—¥"];

        container.innerHTML = "";

        for (let i = 0; i < 7; i++) {
          const d = new Date(base.getTime() + i * 24 * 60 * 60 * 1000);
          const dateStr = formatUTCDate(d);

          const cell = document.createElement("div");
          cell.className = "week-cal-cell";

          const header = document.createElement("div");
          header.className = "week-cal-cell-header";

          const dayLabel = document.createElement("span");
          dayLabel.className = "week-cal-dayname";
          dayLabel.textContent = weekdays[i];

          const dateLabel = document.createElement("span");
          dateLabel.className = "week-cal-daydate";
          dateLabel.textContent = dateStr.slice(5); // MM-DD

          header.appendChild(dayLabel);
          header.appendChild(dateLabel);
          cell.appendChild(header);

          const box = document.createElement("div");
          box.className = "week-cal-events";

          const dayInfo = byDate[dateStr];
          if (dayInfo) {
            cell.classList.add("æœ‰è®­ç»ƒæ‰§è¡Œ");

            // å½“å¤©æ€»é‡Œç¨‹
            const total = document.createElement("div");
            total.className = "week-cal-total";
            total.textContent = `æ€»é‡Œç¨‹: ${dayInfo.totalKm.toFixed(1)} å…¬é‡Œ`;
            box.appendChild(total);

            // æ¯ä¸ª sessionï¼šåå­— + è·ç¦»ï¼ˆé“¾æ¥åˆ° Stravaï¼‰
            dayInfo.sessions.forEach((s) => {
              const line = document.createElement("div");
              line.appendChild(document.createTextNode("â€¢ "));

              if (s.id) {
                const a = document.createElement("a");
                a.href = `https://www.strava.com/activities/${s.id}`;
                a.target = "_blank";
                a.rel = "noopener noreferrer";
                a.textContent = s.name;
                line.appendChild(a);

                const spanDist = document.createElement("span");
                spanDist.textContent = ` â€“ ${s.distance_km.toFixed(1)} å…¬é‡Œ`;
                spanDist.style.marginLeft = "0.25rem";
                line.appendChild(spanDist);
              } else {
                line.textContent = `â€¢ ${s.name} â€“ ${s.distance_km.toFixed(1)} å…¬é‡Œ`;
              }

              box.appendChild(line);
            });
          } else {
            const line = document.createElement("div");
            line.className = "week-cal-empty";
            line.textContent = "æ²¡æœ‰è·‘æ­¥è®­ç»ƒ";
            box.appendChild(line);
          }

          cell.appendChild(box);
      container.appendChild(cell);
    }
  }

      function formatLocationCell(item) {
        const city = item.city;
        const country = item.country;
        if (city && country) return `${city} (${country})`;
        if (city) return city;
        if (country) return country;
        return "";
      }

  // æ‰§è¡Œ sessions è¡¨æ ¼ï¼ˆæŒ‰å¤©åˆå¹¶è¡Œ + å¹³å‡é…é€Ÿ + å¹³å‡å¿ƒç‡ + ä½ç½® + æ¯æ—¥è¯„è®ºï¼‰
  function renderExecSessionsTable(rows) {
    const tbody = document.getElementById("exec-session-body");
    if (!tbody) return;

    tbody.innerHTML = "";

    if (!rows || rows.length === 0) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 8;
      td.textContent = "æœ¬å‘¨å°šæœªæ‰§è¡Œä»»ä½•è¯¾è¡¨";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    // æŒ‰æ—¥æœŸåˆ†ç»„ï¼š{ date: [row, row, ...] }
    const groups = {};
    rows.forEach((item) => {
      if (!groups[item.date]) {
        groups[item.date] = [];
      }
      groups[item.date].push(item);
    });

    const dates = Object.keys(groups).sort();

    dates.forEach((dateStr, groupIndex) => {
      const group = groups[dateStr];

      // å½“å¤©çš„è¯„è®ºï¼šæŠŠæ‰€æœ‰éç©º description åˆå¹¶åœ¨ä¸€èµ·
      const comments = group
        .map((item) => (item.description || "").trim())
        .filter((txt) => txt.length > 0);
      const commentText = comments.join(" ");

      group.forEach((item, idx) => {
        const tr = document.createElement("tr");

        // åŒä¸€å¤©çš„è¡Œä½¿ç”¨ç›¸åŒçš„èƒŒæ™¯è‰²ï¼Œå¥‡å¶å¤©äº¤æ›¿
        if (groupIndex % 2 === 0) {
          tr.classList.add("day-group-even");
        } else {
          tr.classList.add("day-group-odd");
        }

        // ç¬¬ä¸€è¡Œå†™ Day/Dateï¼Œå¹¶è®¾ç½® rowSpan
        if (idx === 0) {
          const tdDay = document.createElement("td");
          tdDay.textContent = item.day;
          tdDay.rowSpan = group.length;

          const tdDate = document.createElement("td");
          tdDate.textContent = item.date;
          tdDate.rowSpan = group.length;

          tr.appendChild(tdDay);
          tr.appendChild(tdDate);
        }

        const tdDist = document.createElement("td");
        tdDist.textContent = `${item.distance_km.toFixed(1)} å…¬é‡Œ`;

        const tdSpeed = document.createElement("td");
        tdSpeed.textContent = formatPaceFromSpeed(item.speed);

        const tdHr = document.createElement("td");
        tdHr.textContent = formatHr(item.hr);

        const tdSession = document.createElement("td");
        if (item.id) {
          const a = document.createElement("a");
          a.href = `https://www.strava.com/activities/${item.id}`;
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.textContent = item.name;
          tdSession.appendChild(a);
        } else {
          tdSession.textContent = item.name;
        }

        const tdLocation = document.createElement("td");
        tdLocation.textContent = formatLocationCell(item);

        tr.appendChild(tdDist);
        tr.appendChild(tdSpeed);
        tr.appendChild(tdHr);
        tr.appendChild(tdSession);
        tr.appendChild(tdLocation);

        // æ¯å¤©çš„è¯„è®ºåˆ—ï¼šåªåœ¨è¯¥å¤©çš„ç¬¬ä¸€è¡Œè¾“å‡ºï¼Œå¹¶è®¾ç½® rowSpanï¼ˆå¸¦â€œå±•å¼€/æ”¶èµ·â€æŒ‰é’®ï¼›è‹¥æ— è¯„è®ºåˆ™ç•™ç©ºï¼‰
        if (idx === 0) {
          const tdComment = document.createElement("td");
          tdComment.rowSpan = group.length;

          if (commentText && commentText.trim().length > 0) {
            const wrap = document.createElement("div");
            wrap.className = "comment-wrap";

            const textDiv = document.createElement("div");
            textDiv.className = "comment-text collapsed";
            textDiv.textContent = commentText;

            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "comment-toggle";
            btn.textContent = "æ›´å¤š";
            btn.addEventListener("click", () => {
              textDiv.classList.toggle("collapsed");
              btn.textContent = textDiv.classList.contains("collapsed")
                ? "æ›´å¤š"
                : "æ›´å°‘";
            });

            wrap.appendChild(textDiv);
            wrap.appendChild(btn);
            tdComment.appendChild(wrap);
          }

          tr.appendChild(tdComment);
        }

        tbody.appendChild(tr);
      });
    });
  }

      document.addEventListener("DOMContentLoaded", loadWeekData);
    </script>




    <script>
    // Garmin/Outlook è®¡åˆ’æ•°æ®ï¼Œæ¥è‡ª fetch_calendar.py ç”Ÿæˆçš„ calendar-events.json
    const CALENDAR_JSON_URL = "../data/calendar-events.json";

    // æ ¹æ® WEEK_START è¿™ä¸€å‘¨ï¼Œä» calendar-events.json ä¸­ç­›é€‰äº‹ä»¶
    async function loadPlanningWeek() {
      try {
        const res = await fetch(CALENDAR_JSON_URL);
        if (!res.ok) {
          console.error("Failed to load calendar events JSON:", res.status);
          return;
        }

        const events = await res.json();

        const info = computeWeekDates(WEEK_START);
        const weekStart = makeUTCDate(info.startStr);
        const weekEnd = makeUTCDate(info.endStr);

        // æŒ‰æ—¥æœŸèšåˆï¼š{ "YYYY-MM-DD": [ {summary}, ... ] }
        const eventsByDate = {};
        events.forEach((ev) => {
          const dateStr = ev.date; // å·²ç»æ˜¯ "YYYY-MM-DD"
          const d = makeUTCDate(dateStr);

          if (d < weekStart || d > weekEnd) return;

          if (!eventsByDate[dateStr]) {
            eventsByDate[dateStr] = [];
          }
          eventsByDate[dateStr].push(ev);
        });

        // ç”¨åŒä¸€æ‰¹æ•°æ®ï¼š
        // 1) ç”»ä¸Šé¢é‚£è¡Œã€Œå‘¨å°æ ¼å­ã€è§†å›¾
        renderWeeklyCalendar(eventsByDate, info);

        // 2) å¡«ä¸‹é¢çš„ã€Œæ¯æ—¥è®¡åˆ’ã€è¡¨
        const flatList = [];
        Object.keys(eventsByDate)
          .sort()
          .forEach((dateStr) => {
            const d = makeUTCDate(dateStr);
            const dayLabel = weekdayShortUTC(d); // e.g. Mon, Tue...
            eventsByDate[dateStr].forEach((ev) => {
              flatList.push({
                date: dateStr,
                day: dayLabel,
                summary: ev.summary,
              });
            });
          });

        renderPlannedSessionsTable(flatList);
      } catch (err) {
        console.error("Error loading planning week:", err);
      }
    }

    // ç”¨äºæŠŠ UTC æ—¥æœŸæ˜ å°„åˆ° "Mon/Tue/..." æ–‡æœ¬
    function weekdayShortUTC(date) {
      const idx = date.getUTCDay(); // 0=Sun..6=Sat
      const names = [ "å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"];
      return names[idx];
    }

    // ä¸Šé¢é‚£ä¸€æ’ã€ŒWeekly planning calendarã€å°æ ¼å­
    function renderWeeklyCalendar(eventsByDate, info) {
      const container = document.getElementById("week-planning-calendar");
      if (!container) return;

      const base = makeUTCDate(info.startStr);
      const weekdays = ["å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­", "å‘¨æ—¥"];

      container.innerHTML = "";

      for (let i = 0; i < 7; i++) {
        const d = new Date(base.getTime() + i * 24 * 60 * 60 * 1000);
        const dateStr = formatUTCDate(d);

        const cell = document.createElement("div");
        cell.className = "week-cal-cell";

        const header = document.createElement("div");
        header.className = "week-cal-cell-header";

        const dayLabel = document.createElement("span");
        dayLabel.className = "week-cal-dayname";
        dayLabel.textContent = weekdays[i];

        const dateLabel = document.createElement("span");
        dateLabel.className = "week-cal-daydate";
        dateLabel.textContent = dateStr.slice(5); // MM-DD

        header.appendChild(dayLabel);
        header.appendChild(dateLabel);

        cell.appendChild(header);

        const evBox = document.createElement("div");
        evBox.className = "week-cal-events";

        const evs = eventsByDate[dateStr];
        if (evs && evs.length > 0) {
          cell.classList.add("æœ‰è®¡åˆ’");
          evs.forEach((ev) => {
            const line = document.createElement("div");
            line.textContent = "â€¢ " + ev.summary;
            evBox.appendChild(line);
          });
        } else {
          const line = document.createElement("div");
          line.className = "week-cal-empty";
          line.textContent = "æ— è®¡åˆ’";
          evBox.appendChild(line);
        }

        cell.appendChild(evBox);
        container.appendChild(cell);
      }
    }

    // æ–°å¢ï¼šè‡ªåŠ¨å¡«å……ã€Œæ¯æ—¥è®¡åˆ’ã€è¡¨æ ¼
    function renderPlannedSessionsTable(flatList) {
      const tbody = document.getElementById("planned-session-body");
      if (!tbody) return;

      tbody.innerHTML = "";

      if (!flatList || flatList.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 3;
        td.textContent = "æœ¬å‘¨æ²¡æœ‰è®­ç»ƒè®¡åˆ’ã€‚";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      flatList.forEach((item) => {
        const tr = document.createElement("tr");

        const tdDay = document.createElement("td");
        tdDay.textContent = item.day;

        const tdDate = document.createElement("td");
        tdDate.textContent = item.date;

        const tdSession = document.createElement("td");
        tdSession.textContent = item.summary;

        tr.appendChild(tdDay);
        tr.appendChild(tdDate);
        tr.appendChild(tdSession);

        tbody.appendChild(tr);
      });
    }

    document.addEventListener("DOMContentLoaded", loadPlanningWeek);
  </script>

</body>
</html>