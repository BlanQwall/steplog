<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StepLog | Weekly Template</title>
  <!-- 注意：模板在 weeklog/ 目录里，所以要用 ../style.css -->
</head>
  <link rel="stylesheet" href="../style.css" />
  <link rel="stylesheet" href="../berlin-2026/assets/season.css" />
    <style>
    .header-main {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .header-text {
      flex: 1 1 auto;
    }
    .berlin-logo {
      max-width: 240px;
      height: auto;
      opacity: 0.9;
    }
    .week-nav {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .week-nav h1 {
      font-size: 1.4rem; /* 缩小标题字号，大概 70% 左右 */
      margin: 0;
    }
    .week-nav-btn {
      padding: 0.18rem 0.42rem; /* 比常规小按钮缩小 */
      font-size: 0.6rem;        /* 约 70% 尺寸 */
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #f5f5f5;
      cursor: pointer;
      line-height: 1.1;
      white-space: nowrap;
    }
    .week-nav-btn:hover:not(:disabled) {
      background: #e8e8e8;
    }
    .week-nav-btn:disabled {
      background: #f0f0f0;
      color: #999;
      border-color: #e0e0e0;
      cursor: default;
    }

    @media (max-width: 720px) {
      .header-main {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
      }

      .header-text {
        max-width: 100%;
      }

      .berlin-logo {
        max-width: 70%;
        height: auto;
        margin-top: 0.5rem;
        align-self: flex-start;
      }
    }

    /* 3 · Memory of the week (responsive grid version) */
    .week-memory-strip {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr)); /* default: 3 per row */
      gap: 0.75rem;
      padding: 0.5rem 0;
    }

    /* if not enough width -> 2 per row */
    @media (max-width: 980px) {
      .week-memory-strip {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    /* if still not enough -> 1 per row */
    @media (max-width: 640px) {
      .week-memory-strip {
        grid-template-columns: 1fr;
      }
    }

    .memory-card {
      width: 100%;
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 12px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }

    .memory-card a {
      text-decoration: none;
      color: inherit;
      display: block;
    }

    .memory-img {
      width: 100%;
      height: 220px;
      object-fit: contain;     /* 关键：不裁切，完整显示 */
      display: block;
      background: #f2f2f2;     /* 留白用作 letterbox */
    }

    .memory-caption {
      padding: 0.35rem 0.55rem; /* less vertical whitespace */
      font-size: 0.75rem;
      line-height: 1.2;
      color: rgba(0,0,0,0.78);
      white-space: nowrap;          /* single line */
      overflow: hidden;
      text-overflow: ellipsis;      /* truncate long names */
    }

    /* .memory-title/.memory-sub are no longer used (single-line caption). */
  </style>
</head>
<body>
  <!-- 顶部脚本：统一控制这一周的起始日期 & 标题 & 日期范围 & 每日日期 -->
  <script>
    // 这一模板可以用于任意一周：
    // 通过 URL 参数 ?week=YYYY-MM-DD 指定周一日期；
    // 如果没有参数，则默认使用“当前周”的周一（按 UTC 日历计算）。
    function getWeekStartFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const value = params.get("week");
      if (value) {
        // 简单返回传入值（假定格式为 YYYY-MM-DD）
        return value;
      }

      // 没有传参时：取“今天”所在周的周一
      const today = new Date();
      const day = today.getUTCDay(); // 0=Sun..6=Sat，按 UTC 计算
      const diff = day === 0 ? -6 : 1 - day; // Monday 相对当天偏移

      const monday = new Date(Date.UTC(
        today.getUTCFullYear(),
        today.getUTCMonth(),
        today.getUTCDate() + diff
      ));

      // 使用统一的 UTC 输出格式 YYYY-MM-DD
      return formatUTCDate(monday);
    }

    // 这一周的「周一」日期，格式 YYYY-MM-DD，由 URL 或当前周自动决定
    const WEEK_START = getWeekStartFromUrl();

    // 模版版本号：手动更新为本文件最后一次修改日期（YYYY-MM-DD）
    const TEMPLATE_VERSION = "2025-12-13";

    // --- 日期工具：不受浏览器本地时区影响，全部按“UTC 日历日”计算 ---

    // 把 "YYYY-MM-DD" 解析成一个“UTC 日期对象”
    function makeUTCDate(ymdStr) {
      const [y, m, d] = ymdStr.split("-").map(Number);
      return new Date(Date.UTC(y, m - 1, d));
    }

    // 以“UTC 日历”输出 YYYY-MM-DD
    function formatUTCDate(date) {
      const y = date.getUTCFullYear();
      const m = String(date.getUTCMonth() + 1).padStart(2, "0");
      const d = String(date.getUTCDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function computeWeekDates(startStr) {
      const start = makeUTCDate(startStr);
      const end = new Date(start.getTime() + 6 * 24 * 60 * 60 * 1000); // +6 days

      return {
        startStr: formatUTCDate(start),
        endStr: formatUTCDate(end),
        label: `Week ${formatUTCDate(start)}`,
        dateRange: `${formatUTCDate(start)} → ${formatUTCDate(end)}`,
      };
    }

    // ---- Training cycle data for Berlin 2026 project ----
    // 使用「周期起始/结束日期」自动生成每周的 startDate，避免手动枚举所有周
    const CYCLES_CONFIG = [
      {
        id: 1,
        name: "Cycle 1 · Alès 10K",
        startDate: "2025-09-29", // 周一
        endDate: "2025-11-09",   // 比赛周的周日（Alès 10K）
      },
      {
        id: 2,
        name: "Cycle 2 · Barcelona HM",
        startDate: "2025-11-10", // 周一
        endDate: "2026-02-15",   // 比赛日（Barcelona Half Marathon）
      },
      {
        id: 3,
        name: "Cycle 3 · Montauban Marathon",
        startDate: "2026-02-23",
        endDate: "2026-03-29",
      },
      {
        id: 4,
        name: "Cycle 4 · France Championship",
        startDate: "2026-04-06",
        endDate: "2026-05-03",
      },
      {
        id: 5,
        name: "Cycle 5 · Summer Block",
        startDate: "2026-05-04",
        endDate: "2026-08-30",
      },
      {
        id: 6,
        name: "Final Cycle · Berlin Marathon 2026",
        startDate: "2026-08-31",
        endDate: "2026-09-27",
      },
    ];

    function generateCyclesData(configs) {
      const result = [];
      const ONE_DAY_MS = 24 * 60 * 60 * 1000;
      configs.forEach((cfg) => {
        const start = makeUTCDate(cfg.startDate);
        const end = makeUTCDate(cfg.endDate);
        const weeks = [];

        let wStart = new Date(start.getTime());
        let order = 1;
        while (wStart <= end) {
          weeks.push({
            order,
            startDate: formatUTCDate(wStart),
          });
          wStart = new Date(wStart.getTime() + 7 * ONE_DAY_MS);
          order += 1;
        }

        result.push({
          id: cfg.id,
          name: cfg.name,
          weeks,
        });
      });
      return result;
    }

    const CYCLES_DATA = generateCyclesData(CYCLES_CONFIG);

    function findCycleInfoForWeek(weekStartStr) {
      for (const cycle of CYCLES_DATA) {
        if (!cycle.weeks) continue;
        const match = cycle.weeks.find((w) => w.startDate === weekStartStr);
        if (match) {
          return {
            cycleName: cycle.name,
            weekOrder: match.order,
          };
        }
      }
      return null;
    }
    function addDaysUTC(ymdStr, days) {
      const base = makeUTCDate(ymdStr);
      const next = new Date(base.getTime() + days * 24 * 60 * 60 * 1000);
      return formatUTCDate(next);
    }

    function checkWeekJsonExists(weekStartStr) {
      // 英文模板对应的周数据文件：week-YYYY-MM-DD.json
      const url = `../data/week-${weekStartStr}.json`;
      return fetch(url, { method: "GET" })
        .then((res) => res.ok)
        .catch(() => false);
    }
        document.addEventListener("DOMContentLoaded", () => {
      const info = computeWeekDates(WEEK_START);

      // Page title
      document.title = `StepLog | ${info.label}`;

      // Top heading & week dates
      document.querySelectorAll("[data-week-label]").forEach((el) => {
        el.textContent = info.label;
      });
      document.querySelectorAll("[data-week-dates]").forEach((el) => {
        el.textContent = info.dateRange;
      });

      // Training cycle: map WEEK_START -> "Cycle X · Week Y"
      const cycleLabelEl = document.getElementById("week-cycle-label");
      if (cycleLabelEl) {
        const cycleInfo = findCycleInfoForWeek(WEEK_START);
        if (cycleInfo) {
          cycleLabelEl.textContent = `${cycleInfo.cycleName} · Week ${cycleInfo.weekOrder}`;
        } else {
          cycleLabelEl.textContent = "–";
        }
      }

      // Footer template version
      const versionEl = document.getElementById("template-version-label");
      if (versionEl && typeof TEMPLATE_VERSION === "string" && TEMPLATE_VERSION) {
        versionEl.textContent = `(version ${TEMPLATE_VERSION})`;
      }

      // Fill per-day dates (Mon–Sun) for any table that uses data-day-offset
      const base = makeUTCDate(info.startStr);
      document.querySelectorAll("tr[data-day-offset]").forEach((row) => {
        const offset = Number(row.getAttribute("data-day-offset") || "0");
        const d = new Date(base.getTime() + offset * 24 * 60 * 60 * 1000);
        const dateStr = formatUTCDate(d);
        const cell = row.querySelector("[data-day-date]");
        if (cell) {
          cell.textContent = dateStr;
        }
      });

      // Prev / next week navigation
      const prevBtn = document.getElementById("prev-week-btn");
      const nextBtn = document.getElementById("next-week-btn");

      const prevWeekStart = addDaysUTC(WEEK_START, -7);
      const nextWeekStart = addDaysUTC(WEEK_START, 7);

      if (prevBtn) {
        checkWeekJsonExists(prevWeekStart).then((exists) => {
          if (exists) {
            prevBtn.disabled = false;
            prevBtn.textContent = "← Previous week";
            prevBtn.addEventListener("click", () => {
              const url = new URL(window.location.href);
              url.searchParams.set("week", prevWeekStart);
              window.location.href = url.pathname + "?" + url.searchParams.toString();
            });
          } else {
            prevBtn.disabled = true;
            prevBtn.textContent = "Already the 1st week";
          }
        });
      }

      if (nextBtn) {
        checkWeekJsonExists(nextWeekStart).then((exists) => {
          if (exists) {
            nextBtn.disabled = false;
            nextBtn.textContent = "Next week →";
            nextBtn.addEventListener("click", () => {
              const url = new URL(window.location.href);
              url.searchParams.set("week", nextWeekStart);
              window.location.href = url.pathname + "?" + url.searchParams.toString();
            });
          } else {
            nextBtn.disabled = true;
            nextBtn.textContent = "Already the last week";
          }
        });
      }
    });
  </script>

  <!-- 顶部导航 -->
  <header class="site-header">
    <div class="container header-inner">
      <div class="logo">StepLog</div>
      <nav class="nav">
        <a href="../index.html">Home</a>
        <a>Weekly View</a>
      </nav>
    </div>
  </header>

  <!-- 当前周概览 -->
  <section class="section week-hero">
    <div class="container">
      <div class="header-main">
        <div class="header-text">
          <div class="week-nav">
            <button id="prev-week-btn" class="week-nav-btn" type="button">← Previous week</button>
            <h1 data-week-label>Week</h1>
            <button id="next-week-btn" class="week-nav-btn" type="button">Next week →</button>
          </div>
          <p class="section-subtitle">
            A preparation for 2026 Berlin Marathon
          </p>
        </div>
        <img src="../berlin-2026/assets/Berlin_2026_logo.png" alt="Berlin 2026 Logo" class="berlin-logo" />
      </div>

      <div class="week-meta-row">
        <div class="meta-pill">
          <span class="meta-label">Week dates</span>
          <span class="meta-value" data-week-dates>YYYY-MM-DD → YYYY-MM-DD</span>
        </div>
        <div class="meta-pill">
          <span class="meta-label">Training cycle</span>
          <span class="meta-value" id="week-cycle-label">##Cycle X · Week Y##</span>
        </div>
      </div>
    </div>
  </section>

  <!-- 1 · Weekly Planning -->
  <section class="section section-alt">
    <div class="container">
      <h2>1 · Weekly Planning</h2>
      <p class="section-subtitle">
        I'm current following Pfizinger 55-70 miles/week plan. This section is synchronized automatically with my Garmin training calendar.
      </p>      

      <!-- 新增：周日历视图（从 Outlook/ICS 转来的 JSON） -->
      <div class="week-calendar-block">
        <h3 class="week-subtitle">Weekly planning calendar</h3>
        <div id="week-planning-calendar" class="week-cal-grid">
          <!-- JS 会在这里填入一整周 Mon–Sun 的小格子 -->
        </div>
      </div>

      <!-- 下半部分：每日计划表（日期自动填充） -->
      <div class="week-table-block">
        <h3 class="week-subtitle">Planned sessions (day by day)</h3>
        <table class="week-table">
          <thead>
            <tr>
              <th>Day</th>
              <th>Date</th>
              <th>Session</th>
            </tr>
          </thead>
          <tbody id="planned-session-body">
            <tr>
              <td colspan="3">Planned sessions will be loaded from calendar-events.json…</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- 2 · Execution & Weekly Summary -->
  <section id="summary" class="section">
    <div class="container">
      <h2>2 · Execution & Weekly Summary</h2>
      <p class="section-subtitle">
        This section is automatically filled during and after the week with Strava data.
      </p>

      <!-- 顶部：指标（部分自动填充） -->

      <div class="week-summary-metrics">
        <div class="metric-card">
          <p class="metric-label">Completed distance</p>
          <p class="metric-value"><span id="completed-distance">–</span></p>
        </div>
        <div class="metric-card">
          <p class="metric-label">Sessions</p>
          <p class="metric-value"><span id="session-count">–</span></p>
        </div>
        <div class="metric-card">
          <p class="metric-label">Everage effort</p>
          <p class="metric-value"><span id="general-feeling">–</span></p>
        </div>
      </div>

      <div class="week-execution-grid">
        <!-- 左侧：周日历 + 列表（来自 Strava） -->
        <div>
          <h3 class="week-subtitle">Executed week calendar (from Strava)</h3>
          <div id="week-exec-calendar" class="week-cal-grid">
            <!-- JS will populate this with Mon–Sun cells -->
          </div>

      <h4 class="week-subtitle week-subtitle-margin-small">
        Executed sessions (day by day)
      </h4>
      <table class="week-table small">
        <thead>
          <tr>
            <th>Day</th>
            <th>Date</th>
            <th>Distance</th>
            <th>Avg pace</th>
            <th>Avg HR</th>
            <th>Session</th>
            <th>Location</th>
            <th>Comment</th>
          </tr>
        </thead>
        <tbody id="exec-session-body">
          <tr>
            <td colspan="6">
              Executed sessions will be loaded from Strava week JSON…
            </td>
          </tr>
        </tbody>
      </table>


        </div>
      </div>
    </div>
  </section>

  <!-- 3 · Memory of the week -->
  <section class="section section-alt">
    <div class="container">
      <h2>3 · Memory of the week</h2>
      <p class="section-subtitle">
        A few snapshots from this week (primary photos from Strava).
      </p>

      <div id="week-memory-strip" class="week-memory-strip">
        <div class="memory-caption">No photos for this week.</div>
      </div>
    </div>
  </section>

  <footer class="site-footer">
    <div class="container footer-inner">
      <p>StepLog · Weekly report <span id="template-version-label"></span></p>
      <p class="footer-sub">Plan first, then learn from each week. © <a href="https://github.com/BlanQwall/">BAI Qiang</a> </p>
    </div>
  </footer>
</body>
  <!-- 底部脚本：Strava 周数据 + Garmin/Outlook 周日历 -->

    <script>
      // Strava 周数据 JSON：由 build_week.py 生成，文件名约定为 week-<WEEK_START>.json
      const WEEK_JSON = `../data/week-${WEEK_START}.json`;

      // 工具：把 m/s 转成 "mm:ss /km"
      function formatPaceFromSpeed(speed) {
        if (typeof speed !== "number" || speed <= 0) return "–";
        const secPerKm = 1000 / speed; // seconds per km
        const totalSec = Math.round(secPerKm);
        const min = Math.floor(totalSec / 60);
        const sec = totalSec % 60;
        return `${min}:${String(sec).padStart(2, "0")} min/km`;
      }

      function formatHr(hr) {
        if (typeof hr !== "number" || hr <= 0) return "–";
        return Math.round(hr) + " bpm";
      }

      async function loadWeekData() {
        try {
          const res = await fetch(WEEK_JSON);
          if (!res.ok) {
            console.error("Failed to load week JSON", res.status);
            return;
          }

          const data = await res.json();
          console.log("Week data loaded:", data);

          // 1) 顶部指标：Completed distance & Sessions & General feeling
          const completedSpan = document.getElementById("completed-distance");
          const sessionsSpan = document.getElementById("session-count");
          const feelingSpan = document.getElementById("general-feeling");

          if (completedSpan && typeof data.total_distance_km === "number") {
            completedSpan.textContent = data.total_distance_km + " km";
          }
          if (sessionsSpan && typeof data.activity_count === "number") {
            sessionsSpan.textContent = data.activity_count;
          }

          if (feelingSpan) {
            let score = data.avg_suffer_score;
            // 如果后端没算到，就在前端用 activities 算一个
            if (typeof score !== "number" && Array.isArray(data.activities)) {
              let sSum = 0;
              let sCount = 0;
              data.activities.forEach((act) => {
                if (typeof act.suffer_score === "number") {
                  sSum += act.suffer_score;
                  sCount += 1;
                }
              });
              if (sCount > 0) score = sSum / sCount;
            }
            if (typeof score === "number") {
              feelingSpan.textContent = (score).toFixed(1);
            }
          }

          // 2) 聚合成 “按天” 的数据，用来画执行周日历 + 表格
          const info = computeWeekDates(WEEK_START);
          const weekStart = makeUTCDate(info.startStr);
          const weekEnd = makeUTCDate(info.endStr);

          const byDate = {};   // { "YYYY-MM-DD": { totalKm, sessions: [{id, name, distance_km, speed, hr}] } }
          const flatList = []; // 执行列表表格行

          if (Array.isArray(data.activities)) {
            data.activities.forEach((act) => {
              if (!act.date) return;
              const dateStr = act.date; // "YYYY-MM-DD"
              const d = makeUTCDate(dateStr);

              if (d < weekStart || d > weekEnd) return; // 只保留这一周

              const dist = typeof act.distance_km === "number" ? act.distance_km : 0;
              const id = act.id;
              const name = act.name || "Session";
              const speed = typeof act.average_speed_m_s === "number" ? act.average_speed_m_s : null;
              const hr = typeof act.average_heartrate === "number" ? act.average_heartrate : null;
              const city = act.city || null;
              const country = act.country || null;
              const description = act.description || "";

              if (!byDate[dateStr]) {
                byDate[dateStr] = { totalKm: 0, sessions: [] };
              }
              byDate[dateStr].totalKm += dist;
              byDate[dateStr].sessions.push({
                id,
                name,
                distance_km: dist,
                speed,
                hr,
              });

              const dayLabel = weekdayShortUTC(d);
              flatList.push({
                day: dayLabel,
                date: dateStr,
                name,
                distance_km: dist,
                id,
                speed,
                hr,
                city,
                country,
                description,
              });
            });
          }

          // 3) 渲染执行周日历 + 执行 sessions 表格
          renderExecWeeklyCalendar(byDate, info);
          renderExecSessionsTable(flatList);
          renderWeekMemoryPhotos(data);
        } catch (err) {
          console.error("Error loading week data:", err);
        }
      }

      // 执行周日历（左边那一排格子）
      function renderExecWeeklyCalendar(byDate, info) {
        const container = document.getElementById("week-exec-calendar");
        if (!container) return;

        const base = makeUTCDate(info.startStr);
        const weekdays = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

        container.innerHTML = "";

        for (let i = 0; i < 7; i++) {
          const d = new Date(base.getTime() + i * 24 * 60 * 60 * 1000);
          const dateStr = formatUTCDate(d);

          const cell = document.createElement("div");
          cell.className = "week-cal-cell";

          const header = document.createElement("div");
          header.className = "week-cal-cell-header";

          const dayLabel = document.createElement("span");
          dayLabel.className = "week-cal-dayname";
          dayLabel.textContent = weekdays[i];

          const dateLabel = document.createElement("span");
          dateLabel.className = "week-cal-daydate";
          dateLabel.textContent = dateStr.slice(5); // MM-DD

          header.appendChild(dayLabel);
          header.appendChild(dateLabel);
          cell.appendChild(header);

          const box = document.createElement("div");
          box.className = "week-cal-events";

          const dayInfo = byDate[dateStr];
          if (dayInfo) {
            cell.classList.add("has-events");

            // 当天总里程
            const total = document.createElement("div");
            total.className = "week-cal-total";
            total.textContent = `Total: ${dayInfo.totalKm.toFixed(1)} km`;
            box.appendChild(total);

            // 每个 session：名字 + 距离（链接到 Strava）
            dayInfo.sessions.forEach((s) => {
              const line = document.createElement("div");
              line.appendChild(document.createTextNode("• "));

              if (s.id) {
                const a = document.createElement("a");
                a.href = `https://www.strava.com/activities/${s.id}`;
                a.target = "_blank";
                a.rel = "noopener noreferrer";
                a.textContent = s.name;
                line.appendChild(a);

                const spanDist = document.createElement("span");
                spanDist.textContent = ` – ${s.distance_km.toFixed(1)} km`;
                spanDist.style.marginLeft = "0.25rem";
                line.appendChild(spanDist);
              } else {
                line.textContent = `• ${s.name} – ${s.distance_km.toFixed(1)} km`;
              }

              box.appendChild(line);
            });
          } else {
            const line = document.createElement("div");
            line.className = "week-cal-empty";
            line.textContent = "No run";
            box.appendChild(line);
          }

          cell.appendChild(box);
      container.appendChild(cell);
    }
  }

      function formatLocationCell(item) {
        const city = item.city;
        const country = item.country;
        if (city && country) return `${city} (${country})`;
        if (city) return city;
        if (country) return country;
        return "";
      }

  // 执行 sessions 表格（按天合并行 + 平均配速 + 平均心率 + 位置 + 每日评论）
  function renderExecSessionsTable(rows) {
    const tbody = document.getElementById("exec-session-body");
    if (!tbody) return;

    tbody.innerHTML = "";

    if (!rows || rows.length === 0) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 8;
      td.textContent = "No executed sessions for this week yet.";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    // 按日期分组：{ date: [row, row, ...] }
    const groups = {};
    rows.forEach((item) => {
      if (!groups[item.date]) {
        groups[item.date] = [];
      }
      groups[item.date].push(item);
    });

    const dates = Object.keys(groups).sort();

    dates.forEach((dateStr, groupIndex) => {
      const group = groups[dateStr];

      // 当天的评论：把所有非空 description 合并在一起
      const comments = group
        .map((item) => (item.description || "").trim())
        .filter((txt) => txt.length > 0);
      const commentText = comments.join(" ");

      group.forEach((item, idx) => {
        const tr = document.createElement("tr");

        // 同一天的行使用相同的背景色，奇偶天交替
        if (groupIndex % 2 === 0) {
          tr.classList.add("day-group-even");
        } else {
          tr.classList.add("day-group-odd");
        }

        // 第一行写 Day/Date，并设置 rowSpan
        if (idx === 0) {
          const tdDay = document.createElement("td");
          tdDay.textContent = item.day;
          tdDay.rowSpan = group.length;

          const tdDate = document.createElement("td");
          tdDate.textContent = item.date;
          tdDate.rowSpan = group.length;

          tr.appendChild(tdDay);
          tr.appendChild(tdDate);
        }

        const tdDist = document.createElement("td");
        tdDist.textContent = `${item.distance_km.toFixed(1)} km`;

        const tdSpeed = document.createElement("td");
        tdSpeed.textContent = formatPaceFromSpeed(item.speed);

        const tdHr = document.createElement("td");
        tdHr.textContent = formatHr(item.hr);

        const tdSession = document.createElement("td");
        if (item.id) {
          const a = document.createElement("a");
          a.href = `https://www.strava.com/activities/${item.id}`;
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.textContent = item.name;
          tdSession.appendChild(a);
        } else {
          tdSession.textContent = item.name;
        }

        const tdLocation = document.createElement("td");
        tdLocation.textContent = formatLocationCell(item);

        tr.appendChild(tdDist);
        tr.appendChild(tdSpeed);
        tr.appendChild(tdHr);
        tr.appendChild(tdSession);
        tr.appendChild(tdLocation);

        // 每天的评论列：只在该天的第一行输出，并设置 rowSpan（带“展开/收起”按钮；若无评论则留空）
        if (idx === 0) {
          const tdComment = document.createElement("td");
          tdComment.rowSpan = group.length;

          if (commentText && commentText.trim().length > 0) {
            const wrap = document.createElement("div");
            wrap.className = "comment-wrap";

            const textDiv = document.createElement("div");
            textDiv.className = "comment-text collapsed";
            textDiv.textContent = commentText;

            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "comment-toggle";
            btn.textContent = "Show more";
            btn.addEventListener("click", () => {
              textDiv.classList.toggle("collapsed");
              btn.textContent = textDiv.classList.contains("collapsed")
                ? "Show more"
                : "Show less";
            });

            wrap.appendChild(textDiv);
            wrap.appendChild(btn);
            tdComment.appendChild(wrap);
          }

          tr.appendChild(tdComment);
        }

        tbody.appendChild(tr);
      });
    });
  }

      document.addEventListener("DOMContentLoaded", loadWeekData);
    </script>

    <script>
    // Garmin/Outlook 计划数据，来自 fetch_calendar.py 生成的 calendar-events.json
    const CALENDAR_JSON_URL = "../data/calendar-events.json";

    // 根据 WEEK_START 这一周，从 calendar-events.json 中筛选事件
    async function loadPlanningWeek() {
      try {
        const res = await fetch(CALENDAR_JSON_URL);
        if (!res.ok) {
          console.error("Failed to load calendar events JSON:", res.status);
          return;
        }

        const events = await res.json();

        const info = computeWeekDates(WEEK_START);
        const weekStart = makeUTCDate(info.startStr);
        const weekEnd = makeUTCDate(info.endStr);

        // 按日期聚合：{ "YYYY-MM-DD": [ {summary}, ... ] }
        const eventsByDate = {};
        events.forEach((ev) => {
          const dateStr = ev.date; // 已经是 "YYYY-MM-DD"
          const d = makeUTCDate(dateStr);

          if (d < weekStart || d > weekEnd) return;

          if (!eventsByDate[dateStr]) {
            eventsByDate[dateStr] = [];
          }
          eventsByDate[dateStr].push(ev);
        });

        // 用同一批数据：
        // 1) 画上面那行「周小格子」视图
        renderWeeklyCalendar(eventsByDate, info);

        // 2) 填下面的「Planned sessions (day by day)」表
        const flatList = [];
        Object.keys(eventsByDate)
          .sort()
          .forEach((dateStr) => {
            const d = makeUTCDate(dateStr);
            const dayLabel = weekdayShortUTC(d); // e.g. Mon, Tue...
            eventsByDate[dateStr].forEach((ev) => {
              flatList.push({
                date: dateStr,
                day: dayLabel,
                summary: ev.summary,
              });
            });
          });

        renderPlannedSessionsTable(flatList);
      } catch (err) {
        console.error("Error loading planning week:", err);
      }
    }

    // 用于把 UTC 日期映射到 "Mon/Tue/..." 文本
    function weekdayShortUTC(date) {
      const idx = date.getUTCDay(); // 0=Sun..6=Sat
      const names = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      return names[idx];
    }

    // 上面那一排「Weekly planning calendar」小格子
    function renderWeeklyCalendar(eventsByDate, info) {
      const container = document.getElementById("week-planning-calendar");
      if (!container) return;

      const base = makeUTCDate(info.startStr);
      const weekdays = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

      container.innerHTML = "";

      for (let i = 0; i < 7; i++) {
        const d = new Date(base.getTime() + i * 24 * 60 * 60 * 1000);
        const dateStr = formatUTCDate(d);

        const cell = document.createElement("div");
        cell.className = "week-cal-cell";

        const header = document.createElement("div");
        header.className = "week-cal-cell-header";

        const dayLabel = document.createElement("span");
        dayLabel.className = "week-cal-dayname";
        dayLabel.textContent = weekdays[i];

        const dateLabel = document.createElement("span");
        dateLabel.className = "week-cal-daydate";
        dateLabel.textContent = dateStr.slice(5); // MM-DD

        header.appendChild(dayLabel);
        header.appendChild(dateLabel);

        cell.appendChild(header);

        const evBox = document.createElement("div");
        evBox.className = "week-cal-events";

        const evs = eventsByDate[dateStr];
        if (evs && evs.length > 0) {
          cell.classList.add("has-events");
          evs.forEach((ev) => {
            const line = document.createElement("div");
            line.textContent = "• " + ev.summary;
            evBox.appendChild(line);
          });
        } else {
          const line = document.createElement("div");
          line.className = "week-cal-empty";
          line.textContent = "No session";
          evBox.appendChild(line);
        }

        cell.appendChild(evBox);
        container.appendChild(cell);
      }
    }

    // 新增：自动填充「Planned sessions (day by day)」表格
    function renderPlannedSessionsTable(flatList) {
      const tbody = document.getElementById("planned-session-body");
      if (!tbody) return;

      tbody.innerHTML = "";

      if (!flatList || flatList.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 3;
        td.textContent = "No planned sessions found for this week.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      flatList.forEach((item) => {
        const tr = document.createElement("tr");

        const tdDay = document.createElement("td");
        tdDay.textContent = item.day;

        const tdDate = document.createElement("td");
        tdDate.textContent = item.date;

        const tdSession = document.createElement("td");
        tdSession.textContent = item.summary;

        tr.appendChild(tdDay);
        tr.appendChild(tdDate);
        tr.appendChild(tdSession);

        tbody.appendChild(tr);
      });
    }

    document.addEventListener("DOMContentLoaded", loadPlanningWeek);

      // 3 · Memory of the week：横向胶片条
      function renderWeekMemoryPhotos(data) {
        const container = document.getElementById("week-memory-strip");
        if (!container) return;

        const photos = Array.isArray(data.photos) ? data.photos : [];
        const activities = Array.isArray(data.activities) ? data.activities : [];

        // 建一个 id -> name 的映射（因为 photos 里我们已经移除了 activity_name）
        const nameById = {};
        activities.forEach((a) => {
          if (a && a.id) nameById[a.id] = a.name || "Session";
        });

        container.innerHTML = "";

        if (!photos.length) {
          const empty = document.createElement("div");
          empty.className = "memory-caption";
          empty.textContent = "No photos for this week.";
          container.appendChild(empty);
          return;
        }

        photos.forEach((p) => {
          const actId = p.activity_id;
          const actName = (actId && nameById[actId]) ? nameById[actId] : "Session";
          const dateStr = p.date || "";
          const photo = p.photo || {};

          // 优先使用较大尺寸（避免 100px 缩略图导致模糊）
          const imgSrc = (photo.url || photo.thumb || "").trim();
          if (!imgSrc) return;

          const card = document.createElement("div");
          card.className = "memory-card";

          const link = document.createElement("a");
          if (actId) {
            link.href = `https://www.strava.com/activities/${actId}`;
            link.target = "_blank";
            link.rel = "noopener noreferrer";
          } else {
            link.href = "#";
          }

          const img = document.createElement("img");
          img.className = "memory-img";
          img.loading = "lazy";
          img.src = imgSrc;
          img.alt = `${actName} (${dateStr})`;
          // If multiple sizes are available, provide srcset for better sharpness on retina
          if (photo.urls && typeof photo.urls === "object") {
            const entries = Object.entries(photo.urls)
              .map(([w, u]) => {
                const ww = parseInt(w, 10);
                if (!ww || !u) return null;
                return `${u} ${ww}w`;
              })
              .filter(Boolean);
            if (entries.length) {
              img.srcset = entries.join(", ");
              img.sizes = "(max-width: 720px) 86vw, 300px";
            }
          }

          // 失败兜底：隐藏损坏图片
          img.addEventListener("error", () => {
            card.remove();
          });

          const cap = document.createElement("div");
          cap.className = "memory-caption";
          cap.textContent = dateStr ? `${actName} (${dateStr})` : actName;

          link.appendChild(img);
          link.appendChild(cap);

          card.appendChild(link);
          container.appendChild(card);
        });

        // 如果所有图片都被过滤掉了（例如加载失败），显示空状态
        if (!container.children.length) {
          const empty = document.createElement("div");
          empty.className = "memory-caption";
          empty.textContent = "No photos for this week.";
          container.appendChild(empty);
        }
      }
    </script>


</html>