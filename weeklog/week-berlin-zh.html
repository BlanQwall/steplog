<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StepLog | Weekly Template (中文)</title>
  <!-- 注意：模板在 weeklog/ 目录里，所以要用 ../style.css -->
</head>
  <link rel="stylesheet" href="../style.css" />
  <link rel="stylesheet" href="../berlin-2026/assets/season.css" />
  <style>
    .header-main {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .header-text {
      flex: 1 1 auto;
    }
    .berlin-logo {
      max-width: 240px;
      height: auto;
      opacity: 0.9;
    }
    .week-nav {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .week-nav h1 {
      font-size: 1.4rem; /* 缩小标题字号（原来大约 2rem 左右） */
      margin: 0;
    }
    .week-nav-btn {
      padding: 0.18rem 0.42rem; /* 比原来缩小约 30% */
      font-size: 0.6rem;        /* 比 0.85rem 缩小到约 70% */
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #f5f5f5;
      cursor: pointer;
      line-height: 1.1;
      white-space: nowrap;
    }
    .week-nav-btn:hover:not(:disabled) {
      background: #e8e8e8;
    }
    .week-nav-btn:disabled {
      background: #f0f0f0;
      color: #999;
      border-color: #e0e0e0;
      cursor: default;
    }
  </style>
</head>
<body>
  <!-- 顶部脚本：统一控制这一周的起始日期 & 标题 & 日期范围 & 每日日期 -->
  <script>
    // 模版版本号：手动更新为本文件最后一次修改日期（YYYY-MM-DD）
    const TEMPLATE_VERSION = "2025-11-23";

    // --- 日期工具：不受浏览器本地时区影响，全部按“UTC 日历日”计算 ---

    // 把 "YYYY-MM-DD" 解析成一个“UTC 日期对象”
    function makeUTCDate(ymdStr) {
      const [y, m, d] = ymdStr.split("-").map(Number);
      return new Date(Date.UTC(y, m - 1, d));
    }

    // 以“UTC 日历”输出 YYYY-MM-DD
    function formatUTCDate(date) {
      const y = date.getUTCFullYear();
      const m = String(date.getUTCMonth() + 1).padStart(2, "0");
      const d = String(date.getUTCDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    // ---- 根据 URL 或当前日期自动决定本周的周一 ----
    // 通过 ?week=YYYY-MM-DD 指定周一日期；
    // 如果没有传参，则默认使用“当前周”的周一（按 UTC 日历计算）。
    function getWeekStartFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const value = params.get("week");
      if (value) {
        // 简单返回传入值（假定格式为 YYYY-MM-DD）
        return value;
      }

      // 没有传参时：取“今天”所在周的周一（按 UTC 计算）
      const today = new Date();
      const day = today.getUTCDay(); // 0=Sun..6=Sat
      const diff = day === 0 ? -6 : 1 - day;

      const monday = new Date(Date.UTC(
        today.getUTCFullYear(),
        today.getUTCMonth(),
        today.getUTCDate() + diff
      ));

      // 使用统一的 UTC 输出格式 YYYY-MM-DD
      return formatUTCDate(monday);
    }

    // 这一周的「周一」日期，格式 YYYY-MM-DD，由 URL 或当前周自动决定
    const WEEK_START = getWeekStartFromUrl();

    function computeWeekDates(startStr) {
      const start = makeUTCDate(startStr);
      const end = new Date(start.getTime() + 6 * 24 * 60 * 60 * 1000); // +6 days

      return {
        startStr: formatUTCDate(start),
        endStr: formatUTCDate(end),
        label: `Week ${formatUTCDate(start)}`,
        dateRange: `${formatUTCDate(start)} → ${formatUTCDate(end)}`,
      };
    }

    // ---- Training cycle data for Berlin 2026 project ----
    // 使用「周期起始/结束日期」自动生成每周的 startDate，避免手动枚举所有周
    const CYCLES_CONFIG = [
      {
        id: 1,
        name: "训练周期1 · 阿莱斯10公里赛",
        startDate: "2025-09-29", // 周一
        endDate: "2025-11-09",   // 比赛周的周日（Alès 10K）
      },
      {
        id: 2,
        name: "训练周期2 · 巴塞罗那半程马拉松",
        startDate: "2025-11-10", // 周一
        endDate: "2026-02-15",   // 比赛日（Barcelona Half Marathon）
      },
      {
        id: 3,
        name: "训练周期3 · 蒙托邦马拉松",
        startDate: "2026-02-23",
        endDate: "2026-03-29",
      },
      {
        id: 4,
        name: "训练周期4 · 法国马拉松锦标赛",
        startDate: "2026-04-06",
        endDate: "2026-05-03",
      },
      {
        id: 5,
        name: "训练周期5 · 夏训周期",
        startDate: "2026-05-04",
        endDate: "2026-08-30",
      },
      {
        id: 6,
        name: "最后准备· 2026柏林马拉松",
        startDate: "2026-08-31",
        endDate: "2026-09-27",
      },
    ];

    function generateCyclesData(configs) {
      const result = [];
      const ONE_DAY_MS = 24 * 60 * 60 * 1000;
      configs.forEach((cfg) => {
        const start = makeUTCDate(cfg.startDate);
        const end = makeUTCDate(cfg.endDate);
        const weeks = [];

        let wStart = new Date(start.getTime());
        let order = 1;
        while (wStart <= end) {
          weeks.push({
            order,
            startDate: formatUTCDate(wStart),
          });
          wStart = new Date(wStart.getTime() + 7 * ONE_DAY_MS);
          order += 1;
        }

        result.push({
          id: cfg.id,
          name: cfg.name,
          weeks,
        });
      });
      return result;
    }

    const CYCLES_DATA = generateCyclesData(CYCLES_CONFIG);

    function findCycleInfoForWeek(weekStartStr) {
      for (const cycle of CYCLES_DATA) {
        if (!cycle.weeks) continue;
        const match = cycle.weeks.find((w) => w.startDate === weekStartStr);
        if (match) {
          return {
            cycleName: cycle.name,
            weekOrder: match.order,
          };
        }
      }
      return null;
    }

    function addDaysUTC(ymdStr, days) {
      const base = makeUTCDate(ymdStr);
      const next = new Date(base.getTime() + days * 24 * 60 * 60 * 1000);
      return formatUTCDate(next);
    }

    function checkWeekJsonExists(weekStartStr) {
      const url = `../data/week-${weekStartStr}.zh.json`;
      // 用 GET 只看状态，不解析内容，兼容 file:/ 和静态服务
      return fetch(url, { method: "GET" })
        .then((res) => res.ok)
        .catch(() => false);
    }

    document.addEventListener("DOMContentLoaded", () => {
      const info = computeWeekDates(WEEK_START);

      // 设置页面标题
      document.title = `StepLog | ${info.label}`;

      // 填充顶部标题 & 周日期
      document.querySelectorAll("[data-week-label]").forEach((el) => {
        el.textContent = `${info.label}当周`;
      });
      document.querySelectorAll("[data-week-dates]").forEach((el) => {
        el.textContent = info.dateRange;
      });

      // 填充 Training cycle：根据 WEEK_START 映射到 "Cycle X · Week Y"
      const cycleLabelEl = document.getElementById("week-cycle-label");
      if (cycleLabelEl) {
        const cycleInfo = findCycleInfoForWeek(WEEK_START);
        if (cycleInfo) {
          cycleLabelEl.textContent = `${cycleInfo.cycleName} · 第${cycleInfo.weekOrder}周`;
        } else {
          // 如果未找到匹配，可以保留占位或清空
          cycleLabelEl.textContent = "–";
        }
      }

      // 填充 footer 中的模版版本号
      const versionEl = document.getElementById("template-version-label");
      if (versionEl && typeof TEMPLATE_VERSION === "string" && TEMPLATE_VERSION) {
        versionEl.textContent = `(版本 ${TEMPLATE_VERSION})`;
      }

      // 为「每日计划表」自动填日期（Mon–Sun）
      const base = makeUTCDate(info.startStr);
      document.querySelectorAll("tr[data-day-offset]").forEach((row) => {
        const offset = Number(row.getAttribute("data-day-offset") || "0");
        const d = new Date(base.getTime() + offset * 24 * 60 * 60 * 1000);
        const dateStr = formatUTCDate(d);
        const cell = row.querySelector("[data-day-date]");
        if (cell) {
          cell.textContent = dateStr;
        }
      });

      // 设置上一周 / 下一周导航按钮
      const prevBtn = document.getElementById("prev-week-btn");
      const nextBtn = document.getElementById("next-week-btn");

      const prevWeekStart = addDaysUTC(WEEK_START, -7);
      const nextWeekStart = addDaysUTC(WEEK_START, 7);

      if (prevBtn) {
        checkWeekJsonExists(prevWeekStart).then((exists) => {
          if (exists) {
            prevBtn.disabled = false;
            prevBtn.textContent = `← 上一周`;
            prevBtn.addEventListener("click", () => {
              const url = new URL(window.location.href);
              url.searchParams.set("week", prevWeekStart);
              window.location.href = url.pathname + "?" + url.searchParams.toString();
            });
          } else {
            prevBtn.disabled = true;
            prevBtn.textContent = "已经第一周";
          }
        });
      }

      if (nextBtn) {
        checkWeekJsonExists(nextWeekStart).then((exists) => {
          if (exists) {
            nextBtn.disabled = false;
            nextBtn.textContent = `下一周 →`;
            nextBtn.addEventListener("click", () => {
              const url = new URL(window.location.href);
              url.searchParams.set("week", nextWeekStart);
              window.location.href = url.pathname + "?" + url.searchParams.toString();
            });
          } else {
            nextBtn.disabled = true;
            nextBtn.textContent = "已到最后一周";
          }
        });
      }
    });
  </script>

  <!-- 顶部导航 -->
  <header class="site-header">
    <div class="container header-inner">
      <div class="logo">StepLog</div>
      <nav class="nav">
        <a href="../index.html">回主页</a>
        <a>周视图</a>
      </nav>
    </div>
  </header>

  <!-- 当前周概览 -->
  <section class="section week-hero">
    <div class="container">
      <div class="header-main">
        <div class="header-text">
          <div class="week-nav">
            <button id="prev-week-btn" class="week-nav-btn" type="button">← 上一周</button>
            <h1 data-week-label>当周</h1>
            <button id="next-week-btn" class="week-nav-btn" type="button">下一周 →</button>
          </div>
          <p class="section-subtitle">
            一个以2026年柏林马拉松为目标的训练季
          </p>
        </div>
        <img src="../berlin-2026/assets/Berlin_2026_logo-zh.png" alt="Berlin 2026 Logo" class="berlin-logo" />
      </div>

      <div class="week-meta-row">
        <div class="meta-pill">
          <span class="meta-label">日期跨度</span>
          <span class="meta-value" data-week-dates>YYYY-MM-DD → YYYY-MM-DD</span>
        </div>
        <div class="meta-pill">
          <span class="meta-label">所处训练阶段</span>
          <span class="meta-value" id="week-cycle-label">##Cycle X · Week Y##</span>
        </div>
      </div>
    </div>
  </section>

  <!-- 1 · Weekly Planning -->
  <section class="section section-alt">
    <div class="container">
      <h2>1 · 本周计划</h2>
      <p class="section-subtitle">
        我现在正在遵循 Pfizinger的每周55-70英里训练计划，配合俱乐部训练。这一部分会以我的Garmin训练日历同步。
      </p>      

      <!-- 新增：周日历视图（从 Outlook/ICS 转来的 JSON） -->
      <div class="week-calendar-block">
        <h3 class="week-subtitle">周日程</h3>
        <div id="week-planning-calendar" class="week-cal-grid">
          <!-- JS 会在这里填入一整周 Mon–Sun 的小格子 -->
        </div>
      </div>

      <!-- 下半部分：每日计划表（日期自动填充） -->
      <div class="week-table-block">
        <h3 class="week-subtitle">每日计划</h3>
        <table class="week-table">
          <thead>
            <tr>
              <th>星期</th>
              <th>日期</th>
              <th>计划</th>
            </tr>
          </thead>
          <tbody id="planned-session-body">
            <tr>
              <td colspan="3">计划会从calendar-events.json自动导入…</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- 2 · 周计划执行概要 -->
  <section id="summary" class="section">
    <div class="container">
      <h2>2 · 周计划执行概要</h2>
      <p class="section-subtitle">
        这一部分将从Strava数据导入.
      </p>

      <!-- 顶部：指标（部分自动填充） -->

      <div class="week-summary-metrics">
        <div class="metric-card">
          <p class="metric-label">完成距离</p>
          <p class="metric-value"><span id="completed-distance">–</span></p>
        </div>
        <div class="metric-card">
          <p class="metric-label">训练课程数量</p>
          <p class="metric-value"><span id="session-count">–</span></p>
        </div>
        <div class="metric-card">
          <p class="metric-label">平均强度</p>
          <p class="metric-value"><span id="general-feeling">–</span></p>
        </div>
      </div>

      <div class="week-execution-grid">
        <!-- 左侧：周日历 + 列表（来自 Strava） -->
        <div>
          <p></p>
          <h3 class="week-subtitle">执行日历(数据来自Strava)</h3>
          <div id="week-exec-calendar" class="week-cal-grid">
            <!-- JS will populate this with Mon–Sun cells -->
          </div>

      <h4 class="week-subtitle week-subtitle-margin-small">
        每日实际训练
      </h4>
      <table class="week-table small">
        <thead>
          <tr>
            <th>星期</th>
            <th>日期</th>
            <th>长度</th>
            <th>平均配速</th>
            <th>平均心率</th>
            <th>训练名称</th>
            <th>地点</th>
            <th>评论和体会</th>
          </tr>
        </thead>
        <tbody id="exec-session-body">
          <tr>
            <td colspan="6">
              已执行的训练数据将从 Strava 周 JSON 文件中加载……
            </td>
          </tr>
        </tbody>
      </table>


        </div>
      </div>
    </div>
  </section>

  <footer class="site-footer">
    <div class="container footer-inner">
      <p>StepLog · 周报告 <span id="template-version-label"></span></p>
      <p class="footer-sub"><b>计划在心，脚踏实地。</b><br>想了解我是谁？看这里 © <a href="https://github.com/BlanQwall/">BAI Qiang</a></p>
    </div>
  </footer>

  <!-- 底部脚本：Strava 周数据 + Garmin/Outlook 周日历 -->

    <script>
      // Strava 周数据 JSON：由 build_week.py 生成，文件名约定为 week-<WEEK_START>.json
      const WEEK_JSON = `../data/week-${WEEK_START}.zh.json`;

      // 工具：把 m/s 转成 "mm:ss /km"
      function formatPaceFromSpeed(speed) {
        if (typeof speed !== "number" || speed <= 0) return "–";
        const secPerKm = 1000 / speed; // seconds per km
        const totalSec = Math.round(secPerKm);
        const min = Math.floor(totalSec / 60);
        const sec = totalSec % 60;
        return `${min}:${String(sec).padStart(2, "0")} 分/公里`;
      }

      function formatHr(hr) {
        if (typeof hr !== "number" || hr <= 0) return "–";
        return Math.round(hr) + " 次/分钟";
      }

      async function loadWeekData() {
        try {
          const res = await fetch(WEEK_JSON);
          if (!res.ok) {
            console.error("Failed to load week JSON", res.status);
            return;
          }

          const data = await res.json();
          console.log("Week data loaded:", data);

          // 1) 顶部指标：Completed distance & Sessions & General feeling
          const completedSpan = document.getElementById("completed-distance");
          const sessionsSpan = document.getElementById("session-count");
          const feelingSpan = document.getElementById("general-feeling");

          if (completedSpan && typeof data.total_distance_km === "number") {
            completedSpan.textContent = data.total_distance_km + " 公里";
          }
          if (sessionsSpan && typeof data.activity_count === "number") {
            sessionsSpan.textContent = data.activity_count;
          }

          if (feelingSpan) {
            let score = data.avg_suffer_score;
            // 如果后端没算到，就在前端用 activities 算一个
            if (typeof score !== "number" && Array.isArray(data.activities)) {
              let sSum = 0;
              let sCount = 0;
              data.activities.forEach((act) => {
                if (typeof act.suffer_score === "number") {
                  sSum += act.suffer_score;
                  sCount += 1;
                }
              });
              if (sCount > 0) score = sSum / sCount;
            }
            if (typeof score === "number") {
              feelingSpan.textContent = (score).toFixed(1);
            }
          }

          // 2) 聚合成 “按天” 的数据，用来画执行周日历 + 表格
          const info = computeWeekDates(WEEK_START);
          const weekStart = makeUTCDate(info.startStr);
          const weekEnd = makeUTCDate(info.endStr);

          const byDate = {};   // { "YYYY-MM-DD": { totalKm, sessions: [{id, name, distance_km, speed, hr}] } }
          const flatList = []; // 执行列表表格行

          if (Array.isArray(data.activities)) {
            data.activities.forEach((act) => {
              if (!act.date) return;
              const dateStr = act.date; // "YYYY-MM-DD"
              const d = makeUTCDate(dateStr);

              if (d < weekStart || d > weekEnd) return; // 只保留这一周

              const dist = typeof act.distance_km === "number" ? act.distance_km : 0;
              const id = act.id;
              const name = act.name || "Session";
              const speed = typeof act.average_speed_m_s === "number" ? act.average_speed_m_s : null;
              const hr = typeof act.average_heartrate === "number" ? act.average_heartrate : null;
              const city = act.city || null;
              const country = act.country || null;
              const description = act.description || "";

              if (!byDate[dateStr]) {
                byDate[dateStr] = { totalKm: 0, sessions: [] };
              }
              byDate[dateStr].totalKm += dist;
              byDate[dateStr].sessions.push({
                id,
                name,
                distance_km: dist,
                speed,
                hr,
              });

              const dayLabel = weekdayShortUTC(d);
              flatList.push({
                day: dayLabel,
                date: dateStr,
                name,
                distance_km: dist,
                id,
                speed,
                hr,
                city,
                country,
                description,
              });
            });
          }

          // 3) 渲染执行周日历 + 执行 sessions 表格
          renderExecWeeklyCalendar(byDate, info);
          renderExecSessionsTable(flatList);
        } catch (err) {
          console.error("Error loading week data:", err);
        }
      }

      // 执行周日历（左边那一排格子）
      function renderExecWeeklyCalendar(byDate, info) {
        const container = document.getElementById("week-exec-calendar");
        if (!container) return;

        const base = makeUTCDate(info.startStr);
        const weekdays = ["周一", "周二", "周三", "周四", "周五", "周六", "周日"];

        container.innerHTML = "";

        for (let i = 0; i < 7; i++) {
          const d = new Date(base.getTime() + i * 24 * 60 * 60 * 1000);
          const dateStr = formatUTCDate(d);

          const cell = document.createElement("div");
          cell.className = "week-cal-cell";

          const header = document.createElement("div");
          header.className = "week-cal-cell-header";

          const dayLabel = document.createElement("span");
          dayLabel.className = "week-cal-dayname";
          dayLabel.textContent = weekdays[i];

          const dateLabel = document.createElement("span");
          dateLabel.className = "week-cal-daydate";
          dateLabel.textContent = dateStr.slice(5); // MM-DD

          header.appendChild(dayLabel);
          header.appendChild(dateLabel);
          cell.appendChild(header);

          const box = document.createElement("div");
          box.className = "week-cal-events";

          const dayInfo = byDate[dateStr];
          if (dayInfo) {
            cell.classList.add("有训练执行");

            // 当天总里程
            const total = document.createElement("div");
            total.className = "week-cal-total";
            total.textContent = `总里程: ${dayInfo.totalKm.toFixed(1)} 公里`;
            box.appendChild(total);

            // 每个 session：名字 + 距离（链接到 Strava）
            dayInfo.sessions.forEach((s) => {
              const line = document.createElement("div");
              line.appendChild(document.createTextNode("• "));

              if (s.id) {
                const a = document.createElement("a");
                a.href = `https://www.strava.com/activities/${s.id}`;
                a.target = "_blank";
                a.rel = "noopener noreferrer";
                a.textContent = s.name;
                line.appendChild(a);

                const spanDist = document.createElement("span");
                spanDist.textContent = ` – ${s.distance_km.toFixed(1)} 公里`;
                spanDist.style.marginLeft = "0.25rem";
                line.appendChild(spanDist);
              } else {
                line.textContent = `• ${s.name} – ${s.distance_km.toFixed(1)} 公里`;
              }

              box.appendChild(line);
            });
          } else {
            const line = document.createElement("div");
            line.className = "week-cal-empty";
            line.textContent = "没有跑步训练";
            box.appendChild(line);
          }

          cell.appendChild(box);
      container.appendChild(cell);
    }
  }

      function formatLocationCell(item) {
        const city = item.city;
        const country = item.country;
        if (city && country) return `${city} (${country})`;
        if (city) return city;
        if (country) return country;
        return "";
      }

  // 执行 sessions 表格（按天合并行 + 平均配速 + 平均心率 + 位置 + 每日评论）
  function renderExecSessionsTable(rows) {
    const tbody = document.getElementById("exec-session-body");
    if (!tbody) return;

    tbody.innerHTML = "";

    if (!rows || rows.length === 0) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 8;
      td.textContent = "本周尚未执行任何课表";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    // 按日期分组：{ date: [row, row, ...] }
    const groups = {};
    rows.forEach((item) => {
      if (!groups[item.date]) {
        groups[item.date] = [];
      }
      groups[item.date].push(item);
    });

    const dates = Object.keys(groups).sort();

    dates.forEach((dateStr, groupIndex) => {
      const group = groups[dateStr];

      // 当天的评论：把所有非空 description 合并在一起
      const comments = group
        .map((item) => (item.description || "").trim())
        .filter((txt) => txt.length > 0);
      const commentText = comments.join(" ");

      group.forEach((item, idx) => {
        const tr = document.createElement("tr");

        // 同一天的行使用相同的背景色，奇偶天交替
        if (groupIndex % 2 === 0) {
          tr.classList.add("day-group-even");
        } else {
          tr.classList.add("day-group-odd");
        }

        // 第一行写 Day/Date，并设置 rowSpan
        if (idx === 0) {
          const tdDay = document.createElement("td");
          tdDay.textContent = item.day;
          tdDay.rowSpan = group.length;

          const tdDate = document.createElement("td");
          tdDate.textContent = item.date;
          tdDate.rowSpan = group.length;

          tr.appendChild(tdDay);
          tr.appendChild(tdDate);
        }

        const tdDist = document.createElement("td");
        tdDist.textContent = `${item.distance_km.toFixed(1)} 公里`;

        const tdSpeed = document.createElement("td");
        tdSpeed.textContent = formatPaceFromSpeed(item.speed);

        const tdHr = document.createElement("td");
        tdHr.textContent = formatHr(item.hr);

        const tdSession = document.createElement("td");
        if (item.id) {
          const a = document.createElement("a");
          a.href = `https://www.strava.com/activities/${item.id}`;
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.textContent = item.name;
          tdSession.appendChild(a);
        } else {
          tdSession.textContent = item.name;
        }

        const tdLocation = document.createElement("td");
        tdLocation.textContent = formatLocationCell(item);

        tr.appendChild(tdDist);
        tr.appendChild(tdSpeed);
        tr.appendChild(tdHr);
        tr.appendChild(tdSession);
        tr.appendChild(tdLocation);

        // 每天的评论列：只在该天的第一行输出，并设置 rowSpan（带“展开/收起”按钮；若无评论则留空）
        if (idx === 0) {
          const tdComment = document.createElement("td");
          tdComment.rowSpan = group.length;

          if (commentText && commentText.trim().length > 0) {
            const wrap = document.createElement("div");
            wrap.className = "comment-wrap";

            const textDiv = document.createElement("div");
            textDiv.className = "comment-text collapsed";
            textDiv.textContent = commentText;

            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "comment-toggle";
            btn.textContent = "更多";
            btn.addEventListener("click", () => {
              textDiv.classList.toggle("collapsed");
              btn.textContent = textDiv.classList.contains("collapsed")
                ? "更多"
                : "更少";
            });

            wrap.appendChild(textDiv);
            wrap.appendChild(btn);
            tdComment.appendChild(wrap);
          }

          tr.appendChild(tdComment);
        }

        tbody.appendChild(tr);
      });
    });
  }

      document.addEventListener("DOMContentLoaded", loadWeekData);
    </script>




    <script>
    // Garmin/Outlook 计划数据，来自 fetch_calendar.py 生成的 calendar-events.zh.json
    const CALENDAR_JSON_URL = "../data/calendar-events.zh.json";

    // 根据 WEEK_START 这一周，从 calendar-events.json 中筛选事件
    async function loadPlanningWeek() {
      try {
        const res = await fetch(CALENDAR_JSON_URL);
        if (!res.ok) {
          console.error("Failed to load calendar events JSON:", res.status);
          return;
        }

        const events = await res.json();

        const info = computeWeekDates(WEEK_START);
        const weekStart = makeUTCDate(info.startStr);
        const weekEnd = makeUTCDate(info.endStr);

        // 按日期聚合：{ "YYYY-MM-DD": [ {summary}, ... ] }
        const eventsByDate = {};
        events.forEach((ev) => {
          const dateStr = ev.date; // 已经是 "YYYY-MM-DD"
          const d = makeUTCDate(dateStr);

          if (d < weekStart || d > weekEnd) return;

          if (!eventsByDate[dateStr]) {
            eventsByDate[dateStr] = [];
          }
          eventsByDate[dateStr].push(ev);
        });

        // 用同一批数据：
        // 1) 画上面那行「周小格子」视图
        renderWeeklyCalendar(eventsByDate, info);

        // 2) 填下面的「每日计划」表
        const flatList = [];
        Object.keys(eventsByDate)
          .sort()
          .forEach((dateStr) => {
            const d = makeUTCDate(dateStr);
            const dayLabel = weekdayShortUTC(d); // e.g. Mon, Tue...
            eventsByDate[dateStr].forEach((ev) => {
              flatList.push({
                date: dateStr,
                day: dayLabel,
                summary: ev.summary,
              });
            });
          });

        renderPlannedSessionsTable(flatList);
      } catch (err) {
        console.error("Error loading planning week:", err);
      }
    }

    // 用于把 UTC 日期映射到 "Mon/Tue/..." 文本
    function weekdayShortUTC(date) {
      const idx = date.getUTCDay(); // 0=Sun..6=Sat
      const names = [ "周日", "周一", "周二", "周三", "周四", "周五", "周六"];
      return names[idx];
    }

    // 上面那一排「Weekly planning calendar」小格子
    function renderWeeklyCalendar(eventsByDate, info) {
      const container = document.getElementById("week-planning-calendar");
      if (!container) return;

      const base = makeUTCDate(info.startStr);
      const weekdays = ["周一", "周二", "周三", "周四", "周五", "周六", "周日"];

      container.innerHTML = "";

      for (let i = 0; i < 7; i++) {
        const d = new Date(base.getTime() + i * 24 * 60 * 60 * 1000);
        const dateStr = formatUTCDate(d);

        const cell = document.createElement("div");
        cell.className = "week-cal-cell";

        const header = document.createElement("div");
        header.className = "week-cal-cell-header";

        const dayLabel = document.createElement("span");
        dayLabel.className = "week-cal-dayname";
        dayLabel.textContent = weekdays[i];

        const dateLabel = document.createElement("span");
        dateLabel.className = "week-cal-daydate";
        dateLabel.textContent = dateStr.slice(5); // MM-DD

        header.appendChild(dayLabel);
        header.appendChild(dateLabel);

        cell.appendChild(header);

        const evBox = document.createElement("div");
        evBox.className = "week-cal-events";

        const evs = eventsByDate[dateStr];
        if (evs && evs.length > 0) {
          cell.classList.add("有计划");
          evs.forEach((ev) => {
            const line = document.createElement("div");
            line.textContent = "• " + ev.summary;
            evBox.appendChild(line);
          });
        } else {
          const line = document.createElement("div");
          line.className = "week-cal-empty";
          line.textContent = "无计划";
          evBox.appendChild(line);
        }

        cell.appendChild(evBox);
        container.appendChild(cell);
      }
    }

    // 新增：自动填充「每日计划」表格
    function renderPlannedSessionsTable(flatList) {
      const tbody = document.getElementById("planned-session-body");
      if (!tbody) return;

      tbody.innerHTML = "";

      if (!flatList || flatList.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 3;
        td.textContent = "本周没有训练计划。";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      flatList.forEach((item) => {
        const tr = document.createElement("tr");

        const tdDay = document.createElement("td");
        tdDay.textContent = item.day;

        const tdDate = document.createElement("td");
        tdDate.textContent = item.date;

        const tdSession = document.createElement("td");
        tdSession.textContent = item.summary;

        tr.appendChild(tdDay);
        tr.appendChild(tdDate);
        tr.appendChild(tdSession);

        tbody.appendChild(tr);
      });
    }

    document.addEventListener("DOMContentLoaded", loadPlanningWeek);
  </script>

</body>
</html>
