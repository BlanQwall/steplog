<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StepLog | Weekly Template</title>
  <!-- æ³¨æ„ï¼šæ¨¡æ¿åœ¨ weeklog/ ç›®å½•é‡Œï¼Œæ‰€ä»¥è¦ç”¨ ../style.css -->
  <link rel="stylesheet" href="../style.css" />
</head>
<body>
  <!-- é¡¶éƒ¨è„šæœ¬ï¼šç»Ÿä¸€æ§åˆ¶è¿™ä¸€å‘¨çš„èµ·å§‹æ—¥æœŸ & æ ‡é¢˜ & æ—¥æœŸèŒƒå›´ & æ¯æ—¥æ—¥æœŸ -->
  <script>
    // âœ… æ¯å‘¨é¡µé¢å¤åˆ¶è¿™ä¸ªæ¨¡æ¿åï¼Œåªéœ€è¦æ”¹è¿™ä¸€è¡Œï¼š
    // è¿™ä¸€å‘¨çš„ã€Œå‘¨ä¸€ã€æ—¥æœŸï¼Œæ ¼å¼ YYYY-MM-DD
    const WEEK_START = "2025-11-17";

    // --- æ—¥æœŸå·¥å…·ï¼šä¸å—æµè§ˆå™¨æœ¬åœ°æ—¶åŒºå½±å“ï¼Œå…¨éƒ¨æŒ‰â€œUTC æ—¥å†æ—¥â€è®¡ç®— ---

    // æŠŠ "YYYY-MM-DD" è§£ææˆä¸€ä¸ªâ€œUTC æ—¥æœŸå¯¹è±¡â€
    function makeUTCDate(ymdStr) {
      const [y, m, d] = ymdStr.split("-").map(Number);
      return new Date(Date.UTC(y, m - 1, d));
    }

    // ä»¥â€œUTC æ—¥å†â€è¾“å‡º YYYY-MM-DD
    function formatUTCDate(date) {
      const y = date.getUTCFullYear();
      const m = String(date.getUTCMonth() + 1).padStart(2, "0");
      const d = String(date.getUTCDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function computeWeekDates(startStr) {
      const start = makeUTCDate(startStr);
      const end = new Date(start.getTime() + 6 * 24 * 60 * 60 * 1000); // +6 days

      return {
        startStr: formatUTCDate(start),
        endStr: formatUTCDate(end),
        label: `Week ${formatUTCDate(start)}`,
        dateRange: `${formatUTCDate(start)} â†’ ${formatUTCDate(end)}`,
      };
    }

    document.addEventListener("DOMContentLoaded", () => {
      const info = computeWeekDates(WEEK_START);

      // è®¾ç½®é¡µé¢æ ‡é¢˜
      document.title = `StepLog | ${info.label}`;

      // å¡«å……é¡¶éƒ¨æ ‡é¢˜ & å‘¨æ—¥æœŸ
      document.querySelectorAll("[data-week-label]").forEach((el) => {
        el.textContent = info.label;
      });
      document.querySelectorAll("[data-week-dates]").forEach((el) => {
        el.textContent = info.dateRange;
      });

      // ä¸ºã€Œæ¯æ—¥è®¡åˆ’è¡¨ã€è‡ªåŠ¨å¡«æ—¥æœŸï¼ˆMonâ€“Sunï¼‰
      const base = makeUTCDate(info.startStr);
      document.querySelectorAll("tr[data-day-offset]").forEach((row) => {
        const offset = Number(row.getAttribute("data-day-offset") || "0");
        const d = new Date(base.getTime() + offset * 24 * 60 * 60 * 1000);
        const dateStr = formatUTCDate(d);
        const cell = row.querySelector("[data-day-date]");
        if (cell) {
          cell.textContent = dateStr;
        }
      });
    });
  </script>

  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <header class="site-header">
    <div class="container header-inner">
      <div class="logo">StepLog</div>
      <nav class="nav">
        <a href="../index.html">Home</a>
        <a>Weekly View</a>
      </nav>
    </div>
  </header>

  <!-- å½“å‰å‘¨æ¦‚è§ˆ -->
  <section class="section week-hero">
    <div class="container">
      <h1 data-week-label>Week</h1>
      <p class="section-subtitle">
        Planning and execution of weekly running program.
      </p>

      <div class="week-meta-row">
        <div class="meta-pill">
          <span class="meta-label">Week dates</span>
          <span class="meta-value" data-week-dates>YYYY-MM-DD â†’ YYYY-MM-DD</span>
        </div>
        <div class="meta-pill">
          <span class="meta-label">Training cycle</span>
    <!-- ğŸŸ¢ğŸŸ¢To fillin training cycle!! ğŸ‘‡ğŸŸ¢ğŸŸ¢ -->
          <span class="meta-value">##Cycle X Â· Week Y##</span>
        </div>
        <div class="meta-pill">
          <span class="meta-label">Focus</span>
    <!-- ğŸŸ¢ğŸŸ¢To fillin focus of week!! ğŸ‘‡ğŸŸ¢ğŸŸ¢ -->
          <span class="meta-value">##Main focus of this week##</span>
        </div>
      </div>
    </div>
  </section>

  <!-- 1 Â· Weekly Planning -->
  <section class="section section-alt">
    <div class="container">
      <h2>1 Â· Weekly Planning</h2>
      <p class="section-subtitle">
        I'm current following Pfizinger 55-70 miles/week plan. This section is synchronized automatically with my Garmin training calendar.
      </p>      

      <!-- æ–°å¢ï¼šå‘¨æ—¥å†è§†å›¾ï¼ˆä» Outlook/ICS è½¬æ¥çš„ JSONï¼‰ -->
      <div class="week-calendar-block">
        <h3 class="week-subtitle">Weekly planning calendar</h3>
        <div id="week-planning-calendar" class="week-cal-grid">
          <!-- JS ä¼šåœ¨è¿™é‡Œå¡«å…¥ä¸€æ•´å‘¨ Monâ€“Sun çš„å°æ ¼å­ -->
        </div>
      </div>

      <!-- ä¸‹åŠéƒ¨åˆ†ï¼šæ¯æ—¥è®¡åˆ’è¡¨ï¼ˆæ—¥æœŸè‡ªåŠ¨å¡«å……ï¼‰ -->
      <div class="week-table-block">
        <h3 class="week-subtitle">Planned sessions (day by day)</h3>
        <table class="week-table">
          <thead>
            <tr>
              <th>Day</th>
              <th>Date</th>
              <th>Session</th>
            </tr>
          </thead>
          <tbody id="planned-session-body">
            <tr>
              <td colspan="3">Planned sessions will be loaded from calendar-events.jsonâ€¦</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- 2 Â· Execution & Weekly Summary -->
  <section id="summary" class="section">
    <div class="container">
      <h2>2 Â· Execution & Weekly Summary</h2>
      <p class="section-subtitle">
        This section is automatically filled during and after the week with Strava data.
      </p>

      <!-- é¡¶éƒ¨ï¼šæŒ‡æ ‡ï¼ˆéƒ¨åˆ†è‡ªåŠ¨å¡«å……ï¼‰ -->

      <div class="week-summary-metrics">
        <div class="metric-card">
          <p class="metric-label">Completed distance</p>
          <p class="metric-value"><span id="completed-distance">â€“</span></p>
        </div>
        <div class="metric-card">
          <p class="metric-label">Sessions</p>
          <p class="metric-value"><span id="session-count">â€“</span></p>
        </div>
        <div class="metric-card">
          <p class="metric-label">Everage effort</p>
          <p class="metric-value"><span id="general-feeling">â€“</span></p>
        </div>
      </div>

      <div class="week-execution-grid">
        <!-- å·¦ä¾§ï¼šå‘¨æ—¥å† + åˆ—è¡¨ï¼ˆæ¥è‡ª Stravaï¼‰ -->
        <div>
          <h3 class="week-subtitle">Executed week calendar (from Strava)</h3>
          <div id="week-exec-calendar" class="week-cal-grid">
            <!-- JS will populate this with Monâ€“Sun cells -->
          </div>

      <h4 class="week-subtitle week-subtitle-margin-small">
        Executed sessions (day by day)
      </h4>
      <table class="week-table small">
        <thead>
          <tr>
            <th>Day</th>
            <th>Date</th>
            <th>Distance</th>
            <th>Avg pace</th>
            <th>Avg HR</th>
            <th>Session</th>
          </tr>
        </thead>
        <tbody id="exec-session-body">
          <tr>
            <td colspan="6">
              Executed sessions will be loaded from Strava week JSONâ€¦
            </td>
          </tr>
        </tbody>
      </table>


        </div>
      </div>

      <div class="week-final-note">
        <h3 class="week-subtitle">Weekly notes</h3>
        <p>I will complete this at the end of week.</p>
      </div>
    </div>
  </section>

  <footer class="site-footer">
    <div class="container footer-inner">
      <p>StepLog Â· Weekly report</p>
      <p class="footer-sub">Plan first, then learn from each week. Â© <a href="https://github.com/BlanQwall/">BAI Qiang</a> </p>
    </div>
  </footer>

  <!-- åº•éƒ¨è„šæœ¬ï¼šStrava å‘¨æ•°æ® + Garmin/Outlook å‘¨æ—¥å† -->

    <script>
      // Strava å‘¨æ•°æ® JSONï¼šç”± build_week.py ç”Ÿæˆï¼Œæ–‡ä»¶åçº¦å®šä¸º week-<WEEK_START>.json
      const WEEK_JSON = `../data/week-${WEEK_START}.json`;

      // å·¥å…·ï¼šæŠŠ m/s è½¬æˆ "mm:ss /km"
      function formatPaceFromSpeed(speed) {
        if (typeof speed !== "number" || speed <= 0) return "â€“";
        const secPerKm = 1000 / speed; // seconds per km
        const totalSec = Math.round(secPerKm);
        const min = Math.floor(totalSec / 60);
        const sec = totalSec % 60;
        return `${min}:${String(sec).padStart(2, "0")} min/km`;
      }

      function formatHr(hr) {
        if (typeof hr !== "number" || hr <= 0) return "â€“";
        return Math.round(hr) + " bpm";
      }

      async function loadWeekData() {
        try {
          const res = await fetch(WEEK_JSON);
          if (!res.ok) {
            console.error("Failed to load week JSON", res.status);
            return;
          }

          const data = await res.json();
          console.log("Week data loaded:", data);

          // 1) é¡¶éƒ¨æŒ‡æ ‡ï¼šCompleted distance & Sessions & General feeling
          const completedSpan = document.getElementById("completed-distance");
          const sessionsSpan = document.getElementById("session-count");
          const feelingSpan = document.getElementById("general-feeling");

          if (completedSpan && typeof data.total_distance_km === "number") {
            completedSpan.textContent = data.total_distance_km + " km";
          }
          if (sessionsSpan && typeof data.activity_count === "number") {
            sessionsSpan.textContent = data.activity_count;
          }

          if (feelingSpan) {
            let score = data.avg_suffer_score;
            // å¦‚æœåç«¯æ²¡ç®—åˆ°ï¼Œå°±åœ¨å‰ç«¯ç”¨ activities ç®—ä¸€ä¸ª
            if (typeof score !== "number" && Array.isArray(data.activities)) {
              let sSum = 0;
              let sCount = 0;
              data.activities.forEach((act) => {
                if (typeof act.suffer_score === "number") {
                  sSum += act.suffer_score;
                  sCount += 1;
                }
              });
              if (sCount > 0) score = sSum / sCount;
            }
            if (typeof score === "number") {
              feelingSpan.textContent = (score).toFixed(1);
            }
          }

          // 2) èšåˆæˆ â€œæŒ‰å¤©â€ çš„æ•°æ®ï¼Œç”¨æ¥ç”»æ‰§è¡Œå‘¨æ—¥å† + è¡¨æ ¼
          const info = computeWeekDates(WEEK_START);
          const weekStart = makeUTCDate(info.startStr);
          const weekEnd = makeUTCDate(info.endStr);

          const byDate = {};   // { "YYYY-MM-DD": { totalKm, sessions: [{id, name, distance_km, speed, hr}] } }
          const flatList = []; // æ‰§è¡Œåˆ—è¡¨è¡¨æ ¼è¡Œ

          if (Array.isArray(data.activities)) {
            data.activities.forEach((act) => {
              if (!act.date) return;
              const dateStr = act.date; // "YYYY-MM-DD"
              const d = makeUTCDate(dateStr);

              if (d < weekStart || d > weekEnd) return; // åªä¿ç•™è¿™ä¸€å‘¨

              const dist = typeof act.distance_km === "number" ? act.distance_km : 0;
              const id = act.id;
              const name = act.name || "Session";
              const speed = typeof act.average_speed_m_s === "number" ? act.average_speed_m_s : null;
              const hr = typeof act.average_heartrate === "number" ? act.average_heartrate : null;

              if (!byDate[dateStr]) {
                byDate[dateStr] = { totalKm: 0, sessions: [] };
              }
              byDate[dateStr].totalKm += dist;
              byDate[dateStr].sessions.push({
                id,
                name,
                distance_km: dist,
                speed,
                hr,
              });

              const dayLabel = weekdayShortUTC(d);
              flatList.push({
                day: dayLabel,
                date: dateStr,
                name,
                distance_km: dist,
                id,
                speed,
                hr,
              });
            });
          }

          // 3) æ¸²æŸ“æ‰§è¡Œå‘¨æ—¥å† + æ‰§è¡Œ sessions è¡¨æ ¼
          renderExecWeeklyCalendar(byDate, info);
          renderExecSessionsTable(flatList);
        } catch (err) {
          console.error("Error loading week data:", err);
        }
      }

      // æ‰§è¡Œå‘¨æ—¥å†ï¼ˆå·¦è¾¹é‚£ä¸€æ’æ ¼å­ï¼‰
      function renderExecWeeklyCalendar(byDate, info) {
        const container = document.getElementById("week-exec-calendar");
        if (!container) return;

        const base = makeUTCDate(info.startStr);
        const weekdays = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

        container.innerHTML = "";

        for (let i = 0; i < 7; i++) {
          const d = new Date(base.getTime() + i * 24 * 60 * 60 * 1000);
          const dateStr = formatUTCDate(d);

          const cell = document.createElement("div");
          cell.className = "week-cal-cell";

          const header = document.createElement("div");
          header.className = "week-cal-cell-header";

          const dayLabel = document.createElement("span");
          dayLabel.className = "week-cal-dayname";
          dayLabel.textContent = weekdays[i];

          const dateLabel = document.createElement("span");
          dateLabel.className = "week-cal-daydate";
          dateLabel.textContent = dateStr.slice(5); // MM-DD

          header.appendChild(dayLabel);
          header.appendChild(dateLabel);
          cell.appendChild(header);

          const box = document.createElement("div");
          box.className = "week-cal-events";

          const dayInfo = byDate[dateStr];
          if (dayInfo) {
            cell.classList.add("has-events");

            // å½“å¤©æ€»é‡Œç¨‹
            const total = document.createElement("div");
            total.className = "week-cal-total";
            total.textContent = `Total: ${dayInfo.totalKm.toFixed(1)} km`;
            box.appendChild(total);

            // æ¯ä¸ª sessionï¼šåå­— + è·ç¦»ï¼ˆé“¾æ¥åˆ° Stravaï¼‰
            dayInfo.sessions.forEach((s) => {
              const line = document.createElement("div");
              line.appendChild(document.createTextNode("â€¢ "));

              if (s.id) {
                const a = document.createElement("a");
                a.href = `https://www.strava.com/activities/${s.id}`;
                a.target = "_blank";
                a.rel = "noopener noreferrer";
                a.textContent = s.name;
                line.appendChild(a);

                const spanDist = document.createElement("span");
                spanDist.textContent = ` â€“ ${s.distance_km.toFixed(1)} km`;
                spanDist.style.marginLeft = "0.25rem";
                line.appendChild(spanDist);
              } else {
                line.textContent = `â€¢ ${s.name} â€“ ${s.distance_km.toFixed(1)} km`;
              }

              box.appendChild(line);
            });
          } else {
            const line = document.createElement("div");
            line.className = "week-cal-empty";
            line.textContent = "No run";
            box.appendChild(line);
          }

          cell.appendChild(box);
          container.appendChild(cell);
        }
      }

      // æ‰§è¡Œ sessions è¡¨æ ¼ï¼ˆæŒ‰å¤©åˆå¹¶è¡Œ + å¹³å‡é…é€Ÿ + å¹³å‡å¿ƒç‡ï¼‰
      function renderExecSessionsTable(rows) {
        const tbody = document.getElementById("exec-session-body");
        if (!tbody) return;

        tbody.innerHTML = "";

        if (!rows || rows.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 6;
          td.textContent = "No executed sessions for this week yet.";
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }

        // æŒ‰æ—¥æœŸåˆ†ç»„ï¼š{ date: [row, row, ...] }
        const groups = {};
        rows.forEach((item) => {
          if (!groups[item.date]) {
            groups[item.date] = [];
          }
          groups[item.date].push(item);
        });

        const dates = Object.keys(groups).sort();

        dates.forEach((dateStr) => {
          const group = groups[dateStr];

          group.forEach((item, idx) => {
            const tr = document.createElement("tr");

            // ç¬¬ä¸€è¡Œå†™ Day/Dateï¼Œå¹¶è®¾ç½® rowSpan
            if (idx === 0) {
              const tdDay = document.createElement("td");
              tdDay.textContent = item.day;
              tdDay.rowSpan = group.length;

              const tdDate = document.createElement("td");
              tdDate.textContent = item.date;
              tdDate.rowSpan = group.length;

              tr.appendChild(tdDay);
              tr.appendChild(tdDate);
            }

            const tdDist = document.createElement("td");
            tdDist.textContent = `${item.distance_km.toFixed(1)} km`;

            const tdSpeed = document.createElement("td");
            tdSpeed.textContent = formatPaceFromSpeed(item.speed);

            const tdHr = document.createElement("td");
            tdHr.textContent = formatHr(item.hr);

            const tdSession = document.createElement("td");
            if (item.id) {
              const a = document.createElement("a");
              a.href = `https://www.strava.com/activities/${item.id}`;
              a.target = "_blank";
              a.rel = "noopener noreferrer";
              a.textContent = item.name;
              tdSession.appendChild(a);
            } else {
              tdSession.textContent = item.name;
            }

            tr.appendChild(tdDist);
            tr.appendChild(tdSpeed);
            tr.appendChild(tdHr);
            tr.appendChild(tdSession);

            tbody.appendChild(tr);
          });
        });
      }

      document.addEventListener("DOMContentLoaded", loadWeekData);
    </script>




    <script>
    // Garmin/Outlook è®¡åˆ’æ•°æ®ï¼Œæ¥è‡ª fetch_calendar.py ç”Ÿæˆçš„ calendar-events.json
    const CALENDAR_JSON_URL = "../data/calendar-events.json";

    // æ ¹æ® WEEK_START è¿™ä¸€å‘¨ï¼Œä» calendar-events.json ä¸­ç­›é€‰äº‹ä»¶
    async function loadPlanningWeek() {
      try {
        const res = await fetch(CALENDAR_JSON_URL);
        if (!res.ok) {
          console.error("Failed to load calendar events JSON:", res.status);
          return;
        }

        const events = await res.json();

        const info = computeWeekDates(WEEK_START);
        const weekStart = makeUTCDate(info.startStr);
        const weekEnd = makeUTCDate(info.endStr);

        // æŒ‰æ—¥æœŸèšåˆï¼š{ "YYYY-MM-DD": [ {summary}, ... ] }
        const eventsByDate = {};
        events.forEach((ev) => {
          const dateStr = ev.date; // å·²ç»æ˜¯ "YYYY-MM-DD"
          const d = makeUTCDate(dateStr);

          if (d < weekStart || d > weekEnd) return;

          if (!eventsByDate[dateStr]) {
            eventsByDate[dateStr] = [];
          }
          eventsByDate[dateStr].push(ev);
        });

        // ç”¨åŒä¸€æ‰¹æ•°æ®ï¼š
        // 1) ç”»ä¸Šé¢é‚£è¡Œã€Œå‘¨å°æ ¼å­ã€è§†å›¾
        renderWeeklyCalendar(eventsByDate, info);

        // 2) å¡«ä¸‹é¢çš„ã€ŒPlanned sessions (day by day)ã€è¡¨
        const flatList = [];
        Object.keys(eventsByDate)
          .sort()
          .forEach((dateStr) => {
            const d = makeUTCDate(dateStr);
            const dayLabel = weekdayShortUTC(d); // e.g. Mon, Tue...
            eventsByDate[dateStr].forEach((ev) => {
              flatList.push({
                date: dateStr,
                day: dayLabel,
                summary: ev.summary,
              });
            });
          });

        renderPlannedSessionsTable(flatList);
      } catch (err) {
        console.error("Error loading planning week:", err);
      }
    }

    // ç”¨äºæŠŠ UTC æ—¥æœŸæ˜ å°„åˆ° "Mon/Tue/..." æ–‡æœ¬
    function weekdayShortUTC(date) {
      const idx = date.getUTCDay(); // 0=Sun..6=Sat
      const names = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      return names[idx];
    }

    // ä¸Šé¢é‚£ä¸€æ’ã€ŒWeekly planning calendarã€å°æ ¼å­
    function renderWeeklyCalendar(eventsByDate, info) {
      const container = document.getElementById("week-planning-calendar");
      if (!container) return;

      const base = makeUTCDate(info.startStr);
      const weekdays = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

      container.innerHTML = "";

      for (let i = 0; i < 7; i++) {
        const d = new Date(base.getTime() + i * 24 * 60 * 60 * 1000);
        const dateStr = formatUTCDate(d);

        const cell = document.createElement("div");
        cell.className = "week-cal-cell";

        const header = document.createElement("div");
        header.className = "week-cal-cell-header";

        const dayLabel = document.createElement("span");
        dayLabel.className = "week-cal-dayname";
        dayLabel.textContent = weekdays[i];

        const dateLabel = document.createElement("span");
        dateLabel.className = "week-cal-daydate";
        dateLabel.textContent = dateStr.slice(5); // MM-DD

        header.appendChild(dayLabel);
        header.appendChild(dateLabel);

        cell.appendChild(header);

        const evBox = document.createElement("div");
        evBox.className = "week-cal-events";

        const evs = eventsByDate[dateStr];
        if (evs && evs.length > 0) {
          cell.classList.add("has-events");
          evs.forEach((ev) => {
            const line = document.createElement("div");
            line.textContent = "â€¢ " + ev.summary;
            evBox.appendChild(line);
          });
        } else {
          const line = document.createElement("div");
          line.className = "week-cal-empty";
          line.textContent = "No session";
          evBox.appendChild(line);
        }

        cell.appendChild(evBox);
        container.appendChild(cell);
      }
    }

    // æ–°å¢ï¼šè‡ªåŠ¨å¡«å……ã€ŒPlanned sessions (day by day)ã€è¡¨æ ¼
    function renderPlannedSessionsTable(flatList) {
      const tbody = document.getElementById("planned-session-body");
      if (!tbody) return;

      tbody.innerHTML = "";

      if (!flatList || flatList.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 3;
        td.textContent = "No planned sessions found for this week.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      flatList.forEach((item) => {
        const tr = document.createElement("tr");

        const tdDay = document.createElement("td");
        tdDay.textContent = item.day;

        const tdDate = document.createElement("td");
        tdDate.textContent = item.date;

        const tdSession = document.createElement("td");
        tdSession.textContent = item.summary;

        tr.appendChild(tdDay);
        tr.appendChild(tdDate);
        tr.appendChild(tdSession);

        tbody.appendChild(tr);
      });
    }

    document.addEventListener("DOMContentLoaded", loadPlanningWeek);
  </script>

</body>
</html>
